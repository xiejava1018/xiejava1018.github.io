<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">



  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  
    
      
    

    
  

  
    
      
    

    
  

  
    
      
    

    
  

  
    
    
    <link href="//fonts.cat.net/css?family=Roboto Slab:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Lobster Two:300,300italic,400,400italic,700,700italic|PT Mono:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.3.0" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.3.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.3.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.3.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.3.0" color="#222">





  <meta name="keywords" content="Hexo, NexT" />




  


  <link rel="alternate" href="/atom.xml" title="XieJava's blog" type="application/atom+xml" />






<meta property="og:type" content="website">
<meta property="og:title" content="XieJava&#39;s blog">
<meta property="og:url" content="http://xiejava.ishareread.com/index.html">
<meta property="og:site_name" content="XieJava&#39;s blog">
<meta property="article:author" content="XieJava">
<meta name="twitter:card" content="summary">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '6.3.0',
    sidebar: {"position":"right","display":"hide","offset":12,"b2t":false,"scrollpercent":true,"onmobile":true},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: 'undefined',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://xiejava.ishareread.com/"/>





  <title>XieJava's blog</title>
  








<meta name="generator" content="Hexo 4.2.1"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-right 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">XieJava's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description">记录最好的自己</h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://xiejava.ishareread.com/posts/5c086d45/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="XieJava">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://img9.doubanio.com/icon/ul70489051-4.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="XieJava's blog">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/posts/5c086d45/" itemprop="url">ClaudeCode安装教程（小白版）</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2026-02-27T17:58:07+08:00">
                2026-02-27
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">更新于&#58;</span>
              
              <time title="更新于" itemprop="dateModified" datetime="2026-02-27T15:25:06+08:00">
                2026-02-27
              </time>
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index">
                    <span itemprop="name">技术</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%8A%80%E6%9C%AF/%E5%BC%80%E5%8F%91/" itemprop="url" rel="index">
                    <span itemprop="name">开发</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/posts/5c086d45/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/posts/5c086d45/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/posts/5c086d45/" class="leancloud_visitors" data-flag-title="ClaudeCode安装教程（小白版）">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  1.8k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  7
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="什么是-Claude-Code？"><a href="#什么是-Claude-Code？" class="headerlink" title="什么是 Claude Code？"></a>什么是 Claude Code？</h2><p>Claude Code 是一个智能编码助手，它可以在你的<strong>命令行终端</strong>中运行。你可以像和真人聊天一样，用自然语言告诉它你想做什么（比如”帮我写一个函数”、”修复这个bug”），它会自动帮你完成代码编写、调试、重构等任务。</p>
<p><strong>主要特点：</strong></p>
<ul>
<li>在终端中直接对话，无需切换窗口</li>
<li>自动读取和理解你的项目代码</li>
<li>可以直接修改文件、执行命令</li>
<li>支持 GLM Coding Plan（智谱 AI 的模型）</li>
</ul>
<hr>
<h2 id="前置准备"><a href="#前置准备" class="headerlink" title="前置准备"></a>前置准备</h2><h3 id="1-安装-Node-js（必需）"><a href="#1-安装-Node-js（必需）" class="headerlink" title="1. 安装 Node.js（必需）"></a>1. 安装 Node.js（必需）</h3><p>Claude Code 需要 Node.js 18 或更高版本。</p>
<h4 id="检查是否已安装-Node-js"><a href="#检查是否已安装-Node-js" class="headerlink" title="检查是否已安装 Node.js"></a>检查是否已安装 Node.js</h4><p>打开终端（Terminal），输入：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">node --version</span><br><span class="line">npm --version</span><br></pre></td></tr></table></figure>

<ul>
<li>如果显示版本号（如 <code>v18.x.x</code> 或 <code>v20.x.x</code>），说明已安装，可以跳过这一步</li>
<li>如果提示”命令未找到”，需要先安装 Node.js</li>
</ul>
<h4 id="安装-Node-js"><a href="#安装-Node-js" class="headerlink" title="安装 Node.js"></a>安装 Node.js</h4><p><strong>Mac 用户推荐方式：使用 nvm（版本管理器）</strong></p>
<p>nvm 可以让你在同一台电脑上安装和管理多个 Node.js 版本。</p>
<ol>
<li><p>安装 nvm：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash</span><br></pre></td></tr></table></figure>
</li>
<li><p>重新打开终端，或执行以下命令使 nvm 生效：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> NVM_DIR=<span class="string">"<span class="variable">$HOME</span>/.nvm"</span></span><br><span class="line">[ -s <span class="string">"<span class="variable">$NVM_DIR</span>/nvm.sh"</span> ] &amp;&amp; \. <span class="string">"<span class="variable">$NVM_DIR</span>/nvm.sh"</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>安装最新的 Node.js LTS 版本：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nvm install --lts</span><br><span class="line">nvm use lts</span><br></pre></td></tr></table></figure>
</li>
<li><p>设置为默认版本：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nvm <span class="built_in">alias</span> default lts/*</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p><strong>Mac 用户备用方式：使用 Homebrew</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 如果没有安装 Homebrew，先安装它</span></span><br><span class="line">/bin/bash -c <span class="string">"<span class="variable">$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装 Node.js</span></span><br><span class="line">brew install node</span><br></pre></td></tr></table></figure>

<p><strong>Windows 用户：</strong></p>
<ol>
<li>访问 <a href="https://nodejs.org/" target="_blank" rel="noopener">Node.js 官网</a></li>
<li>下载 LTS 版本（长期支持版）</li>
<li>运行安装程序，一路”下一步”即可</li>
</ol>
<p><strong>同时安装 Git for Windows（Windows 用户必需）：</strong></p>
<ol>
<li>访问 <a href="https://git-scm.com/download/win" target="_blank" rel="noopener">Git 官网</a></li>
<li>下载并安装，使用默认设置即可</li>
</ol>
<hr>
<h2 id="安装-Claude-Code"><a href="#安装-Claude-Code" class="headerlink" title="安装 Claude Code"></a>安装 Claude Code</h2><h3 id="方式一：npm-命令行安装（推荐）"><a href="#方式一：npm-命令行安装（推荐）" class="headerlink" title="方式一：npm 命令行安装（推荐）"></a>方式一：npm 命令行安装（推荐）</h3><ol>
<li><p>打开终端（Mac/Linux）或 PowerShell/CMD（Windows）</p>
</li>
<li><p>执行安装命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install -g @anthropic-ai/claude-code</span><br></pre></td></tr></table></figure>
</li>
<li><p>验证安装是否成功：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">claude --version</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>如果显示版本号（如 <code>2.0.14</code>），说明安装成功！</p>
<h3 id="方式二：使用-Cursor-编辑器引导安装"><a href="#方式二：使用-Cursor-编辑器引导安装" class="headerlink" title="方式二：使用 Cursor 编辑器引导安装"></a>方式二：使用 Cursor 编辑器引导安装</h3><p>如果你有 Cursor 编辑器但不熟悉命令行：</p>
<ol>
<li>打开 Cursor</li>
<li>按 <code>Cmd + L</code>（Mac）或 <code>Ctrl + L</code>（Windows）打开聊天面板</li>
<li>输入：<code>Help me install Claude Code</code></li>
<li>Cursor 会引导你完成安装过程</li>
</ol>
<hr>
<h2 id="配置国内模型"><a href="#配置国内模型" class="headerlink" title="配置国内模型"></a>配置国内模型</h2><p>Claude Code需要接入大模型才能发挥作用，对于国内环境各个模型大厂都推出了Coding Plan套餐，以下以智谱AI的为例，安装完成后，需要配置智谱 AI 的 API Key 才能使用GLM-5模型。</p>
<h3 id="获取-API-Key"><a href="#获取-API-Key" class="headerlink" title="获取 API Key"></a>获取 API Key</h3><ol>
<li>访问 <a href="https://open.bigmodel.cn/" target="_blank" rel="noopener">智谱 AI 开放平台</a></li>
<li>注册/登录账号</li>
<li>进入”API Key”管理页面</li>
<li>创建新的 API Key 并复制保存</li>
</ol>
<h3 id="配置方式"><a href="#配置方式" class="headerlink" title="配置方式"></a>配置方式</h3><ol>
<li><p>启动 Claude Code：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">claude</span><br></pre></td></tr></table></figure>
</li>
<li><p>首次启动会提示配置 API，选择”Manual setup”或手动配置</p>
</li>
<li><p>配置环境变量：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> ANTHROPIC_API_KEY=<span class="string">"你的API_Key"</span></span><br></pre></td></tr></table></figure>

</li>
</ol>
<p><strong>Windows PowerShell 用户：</strong></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$env:ANTHROPIC_API_KEY</span>=<span class="string">"你的API_Key"</span></span><br></pre></td></tr></table></figure>

<ol start="4">
<li>永久保存配置（推荐）：</li>
</ol>
<p>创建或编辑配置文件 <code>~/.claude/settings.json</code>（Mac/Linux）或 <code>%USERPROFILE%\.claude\settings.json</code>（Windows）：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"env"</span>: &#123;</span><br><span class="line">    <span class="attr">"ANTHROPIC_API_KEY"</span>: <span class="string">"你的API_Key"</span>,</span><br><span class="line">    <span class="attr">"ANTHROPIC_BASE_URL"</span>: <span class="string">"https://open.bigmodel.cn/api/paas/v4/"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="开始使用"><a href="#开始使用" class="headerlink" title="开始使用"></a>开始使用</h2><h3 id="1-启动-Claude-Code"><a href="#1-启动-Claude-Code" class="headerlink" title="1. 启动 Claude Code"></a>1. 启动 Claude Code</h3><p>进入你的项目目录，然后运行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /path/to/your/project</span><br><span class="line">claude</span><br></pre></td></tr></table></figure>

<h3 id="2-首次启动"><a href="#2-首次启动" class="headerlink" title="2. 首次启动"></a>2. 首次启动</h3><ul>
<li>Claude Code 会询问是否信任该目录，选择 <strong>“Trust”</strong> 或 <strong>“Yes”</strong></li>
<li>这样 Claude Code 才能读取和修改你的项目文件</li>
</ul>
<h3 id="3-基本使用"><a href="#3-基本使用" class="headerlink" title="3. 基本使用"></a>3. 基本使用</h3><p>启动后，你可以直接输入自然语言命令：</p>
<p><strong>示例：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; 帮我写一个 Python 函数，计算斐波那契数列</span><br><span class="line">&gt; 解释这个函数的作用</span><br><span class="line">&gt; 找出代码中所有的 console.log 并删除</span><br><span class="line">&gt; 运行测试用例</span><br></pre></td></tr></table></figure>

<p><strong>常用命令：</strong></p>
<ul>
<li><code>/help</code> - 查看帮助信息</li>
<li><code>/status</code> - 查看当前配置和状态</li>
<li><code>/exit</code> - 退出 Claude Code</li>
</ul>
<hr>
<h2 id="切换模型（可选）"><a href="#切换模型（可选）" class="headerlink" title="切换模型（可选）"></a>切换模型（可选）</h2><p>Claude Code 支持多种智谱 AI 模型，你可以手动切换。</p>
<h3 id="修改配置文件"><a href="#修改配置文件" class="headerlink" title="修改配置文件"></a>修改配置文件</h3><p>编辑 <code>~/.claude/settings.json</code>：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"env"</span>: &#123;</span><br><span class="line">    <span class="attr">"ANTHROPIC_API_KEY"</span>: <span class="string">"你的API_Key"</span>,</span><br><span class="line">    <span class="attr">"ANTHROPIC_BASE_URL"</span>: <span class="string">"https://open.bigmodel.cn/api/paas/v4/"</span>,</span><br><span class="line">    <span class="attr">"ANTHROPIC_DEFAULT_HAIKU_MODEL"</span>: <span class="string">"glm-4.5-air"</span>,</span><br><span class="line">    <span class="attr">"ANTHROPIC_DEFAULT_SONNET_MODEL"</span>: <span class="string">"glm-4.7"</span>,</span><br><span class="line">    <span class="attr">"ANTHROPIC_DEFAULT_OPUS_MODEL"</span>: <span class="string">"glm-5"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>模型说明：</strong></p>
<ul>
<li><code>glm-4.5-air</code>：轻量级模型，响应快速，适合简单任务</li>
<li><code>glm-4.7</code>：主力模型，平衡性能和质量</li>
<li><code>glm-5</code>：最新模型，能力最强，适合复杂任务</li>
</ul>
<h3 id="验证配置"><a href="#验证配置" class="headerlink" title="验证配置"></a>验证配置</h3><p>重新启动 Claude Code，输入 <code>/status</code> 查看当前使用的模型。</p>
<hr>
<h2 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h2><h3 id="Q1-npm-install-提示权限错误（Mac-Linux）"><a href="#Q1-npm-install-提示权限错误（Mac-Linux）" class="headerlink" title="Q1: npm install 提示权限错误（Mac/Linux）"></a>Q1: npm install 提示权限错误（Mac/Linux）</h3><p><strong>解决方案：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用 sudo 安装（不推荐，但最简单）</span></span><br><span class="line">sudo npm install -g @anthropic-ai/claude-code</span><br><span class="line"></span><br><span class="line"><span class="comment"># 或配置 npm 全局目录（推荐）</span></span><br><span class="line">mkdir ~/.npm-global</span><br><span class="line">npm config <span class="built_in">set</span> prefix <span class="string">'~/.npm-global'</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">'export PATH=~/.npm-global/bin:$PATH'</span> &gt;&gt; ~/.bashrc</span><br><span class="line"><span class="built_in">source</span> ~/.bashrc</span><br><span class="line">npm install -g @anthropic-ai/claude-code</span><br></pre></td></tr></table></figure>

<h3 id="Q2-配置文件修改后不生效"><a href="#Q2-配置文件修改后不生效" class="headerlink" title="Q2: 配置文件修改后不生效"></a>Q2: 配置文件修改后不生效</h3><p><strong>解决步骤：</strong></p>
<ol>
<li>关闭所有 Claude Code 窗口</li>
<li>重新打开终端</li>
<li>再次运行 <code>claude</code> 启动</li>
<li>如果问题仍存在，删除 <code>~/.claude/settings.json</code>，重新配置</li>
</ol>
<h3 id="Q3-如何升级到最新版本？"><a href="#Q3-如何升级到最新版本？" class="headerlink" title="Q3: 如何升级到最新版本？"></a>Q3: 如何升级到最新版本？</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 检查当前版本</span></span><br><span class="line">claude --version</span><br><span class="line"></span><br><span class="line"><span class="comment"># 升级到最新版本</span></span><br><span class="line">claude update</span><br></pre></td></tr></table></figure>

<p>推荐使用最新版本以获得最佳体验。</p>
<h3 id="Q4-Windows-下提示找不到-claude-命令"><a href="#Q4-Windows-下提示找不到-claude-命令" class="headerlink" title="Q4: Windows 下提示找不到 claude 命令"></a>Q4: Windows 下提示找不到 claude 命令</h3><p><strong>解决方案：</strong></p>
<ol>
<li>确保 npm 全局安装路径在系统 PATH 中</li>
<li>查找 npm 全局路径：<code>npm config get prefix</code></li>
<li>将该路径下的 <code>bin</code> 目录添加到系统环境变量 PATH 中</li>
<li>或使用 PowerShell 重新安装：<code>npm install -g @anthropic-ai/claude-code</code></li>
</ol>
<h3 id="Q5-如何在项目中使用？"><a href="#Q5-如何在项目中使用？" class="headerlink" title="Q5: 如何在项目中使用？"></a>Q5: 如何在项目中使用？</h3><p>进入任何项目目录后启动：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /path/to/your/project</span><br><span class="line">claude</span><br></pre></td></tr></table></figure>

<p>Claude Code 会自动扫描并理解项目结构，可以帮你完成：</p>
<ul>
<li>代码生成和补全</li>
<li>Bug 修复和调试</li>
<li>代码重构和优化</li>
<li>添加注释和文档</li>
</ul>
<hr>
<h2 id="推荐工作流"><a href="#推荐工作流" class="headerlink" title="推荐工作流"></a>推荐工作流</h2><h3 id="日常开发流程"><a href="#日常开发流程" class="headerlink" title="日常开发流程"></a>日常开发流程</h3><ol>
<li><p><strong>启动项目</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> my-project</span><br><span class="line">claude</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>描述需求</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; 帮我创建一个用户登录页面，使用 HTML + CSS + JavaScript</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>迭代优化</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; 给登录按钮添加 hover 效果</span><br><span class="line">&gt; 添加表单验证功能</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>调试问题</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; 为什么点击登录后没有反应？帮我检查代码</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h3 id="团队协作"><a href="#团队协作" class="headerlink" title="团队协作"></a>团队协作</h3><ul>
<li>Claude Code 可以读取整个项目代码库</li>
<li>可以帮你理解别人的代码</li>
<li>可以协助 Code Review</li>
<li>可以生成文档和注释</li>
</ul>
<hr>
<h2 id="进阶配置"><a href="#进阶配置" class="headerlink" title="进阶配置"></a>进阶配置</h2><h3 id="配置视觉-MCP-服务器（图片识别）"><a href="#配置视觉-MCP-服务器（图片识别）" class="headerlink" title="配置视觉 MCP 服务器（图片识别）"></a>配置视觉 MCP 服务器（图片识别）</h3><p>如果你需要让 Claude Code 识别和分析图片，可以配置视觉 MCP 服务器。</p>
<p>参考文档：<a href="https://docs.bigmodel.cn/cn/coding-plan/mcp/vision" target="_blank" rel="noopener">视觉MCP服务器</a></p>
<h3 id="配置搜索-MCP-服务器（联网搜索）"><a href="#配置搜索-MCP-服务器（联网搜索）" class="headerlink" title="配置搜索 MCP 服务器（联网搜索）"></a>配置搜索 MCP 服务器（联网搜索）</h3><p>如果你需要让 Claude Code 搜索最新信息，可以配置搜索 MCP 服务器。</p>
<p>参考文档：<a href="https://docs.bigmodel.cn/cn/coding-plan/mcp/search" target="_blank" rel="noopener">搜索MCP服务器</a></p>
<h3 id="配置网页读取-MCP-服务器"><a href="#配置网页读取-MCP-服务器" class="headerlink" title="配置网页读取 MCP 服务器"></a>配置网页读取 MCP 服务器</h3><p>如果你需要让 Claude Code 读取网页内容，可以配置网页读取 MCP 服务器。</p>
<p>参考文档：<a href="https://docs.bigmodel.cn/cn/coding-plan/mcp/web-reader" target="_blank" rel="noopener">网页读取MCP服务器</a></p>
<hr>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>安装 Claude Code 只需要三步：</p>
<ol>
<li>✅ 安装 Node.js 18+</li>
<li>✅ 运行 <code>npm install -g @anthropic-ai/claude-code</code></li>
<li>✅ 配置智谱 AI API Key</li>
</ol>
<p>安装后，在任何项目目录运行 <code>claude</code> 即可开始使用！</p>
<hr>
<h2 id="参考资源"><a href="#参考资源" class="headerlink" title="参考资源"></a>参考资源</h2><ul>
<li><a href="https://docs.anthropic.com/zh-CN/docs/claude-code/overview" target="_blank" rel="noopener">Claude Code 官方文档</a></li>
<li><a href="https://open.bigmodel.cn/" target="_blank" rel="noopener">智谱 AI 开放平台</a></li>
<li><a href="https://docs.bigmodel.cn/cn/coding-plan/tool/claude" target="_blank" rel="noopener">GLM Coding Plan 文档</a></li>
<li><a href="https://nodejs.org/" target="_blank" rel="noopener">Node.js 官网</a></li>
<li><a href="https://github.com/nvm-sh/nvm" target="_blank" rel="noopener">nvm GitHub</a></li>
</ul>
<hr>
<p>作者博客：<a href="http://xiejava.ishareread.com/">http://xiejava.ishareread.com/</a></p>
<center> 

<br>

<p><img src="http://image2.ishareread.com/images/fullbug%E5%BE%AE%E4%BF%A1%E5%85%AC%E4%BC%97%E5%8F%B7.jpg" alt="“fullbug”微信公众号" title="“fullbug”微信公众号"> </p>
<p>关注：微信公众号,一起学习成长！</center></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://xiejava.ishareread.com/posts/5c086d44/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="XieJava">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://img9.doubanio.com/icon/ul70489051-4.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="XieJava's blog">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/posts/5c086d44/" itemprop="url">网络安全资产画像实战</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2026-02-20T17:58:07+08:00">
                2026-02-20
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">更新于&#58;</span>
              
              <time title="更新于" itemprop="dateModified" datetime="2026-02-20T18:19:24+08:00">
                2026-02-20
              </time>
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index">
                    <span itemprop="name">技术</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%8A%80%E6%9C%AF/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/" itemprop="url" rel="index">
                    <span itemprop="name">网络安全</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/posts/5c086d44/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/posts/5c086d44/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/posts/5c086d44/" class="leancloud_visitors" data-flag-title="网络安全资产画像实战">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  1.2k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  4
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>资产是安全防守的基石。如果你不知道自己有什么，就不可能保护好它们。在网络安全攻防实战中，企业对自己资产的了解程度往往远低于攻击者。攻击者只需要找到一个入口点，而防守者需要保护所有可能的入口，资产画像就是解决这个问题的核心方法论。</p>
<h1 id="【什么是资产画像？】"><a href="#【什么是资产画像？】" class="headerlink" title="【什么是资产画像？】"></a>【什么是资产画像？】</h1><p>资产画像是对网络空间中每一项资产进行全方位、多维度描述的过程。目标是回答三个核心问题：</p>
<ol>
<li>这资产是什么？—— 身份与属性</li>
<li>暴露面有多大？—— 可攻击面</li>
<li>风险有多少？—— 脆弱性与影响</li>
</ol>
<h1 id="【资产画像的七大核心维度】"><a href="#【资产画像的七大核心维度】" class="headerlink" title="【资产画像的七大核心维度】"></a>【资产画像的七大核心维度】</h1><h2 id="一、身份维度（是谁）"><a href="#一、身份维度（是谁）" class="headerlink" title="一、身份维度（是谁）"></a>一、身份维度（是谁）</h2><ul>
<li>资产标识：IP、MAC、主机名、域名</li>
<li>资产类型：服务器、网络设备、安全设备、终端、IoT、云资源</li>
<li>资产权属：所属业务、所属部门、责任人</li>
<li>生命周期：入网时间、退役时间、状态</li>
<li>实战要点：建立统一命名规范，确保对应关系准确，关注云环境弹性资产</li>
</ul>
<h2 id="二、暴露面维度（在哪）"><a href="#二、暴露面维度（在哪）" class="headerlink" title="二、暴露面维度（在哪）"></a>二、暴露面维度（在哪）</h2><ul>
<li>网络位置：内网/DMZ/外网/云上</li>
<li>可达性：从互联网是否可直接访问</li>
<li>开放端口与服务：22、80、443、3389、3306等</li>
<li>攻击面：外部暴露点、可被利用的入口</li>
<li>实战要点：互联网暴露资产是重中之重，关注非常规端口，区分主动/被动暴露</li>
</ul>
<h2 id="三、脆弱性维度（有什么弱点）"><a href="#三、脆弱性维度（有什么弱点）" class="headerlink" title="三、脆弱性维度（有什么弱点）"></a>三、脆弱性维度（有什么弱点）</h2><ul>
<li>系统漏洞：CVE编号、CVSS评分、PoC状态</li>
<li>配置缺陷：弱口令、默认配置、未授权访问</li>
<li>补丁状态：缺失的关键补丁</li>
<li>组件风险：Log4j、Fastjson等高危组件</li>
<li>实战要点：漏洞数量不重要，可利用性才重要，关注N-day漏洞武器化程度</li>
</ul>
<h2 id="四、价值维度（值不值得保护）"><a href="#四、价值维度（值不值得保护）" class="headerlink" title="四、价值维度（值不值得保护）"></a>四、价值维度（值不值得保护）</h2><ul>
<li>数据敏感度：是否含敏感数据、数据级别</li>
<li>业务重要性：核心系统/一般系统/边缘系统</li>
<li>影响范围：一旦失陷影响面多大</li>
<li>实战要点：核心业务+敏感数据=最高防护优先级，关注低调但重要的资产</li>
</ul>
<h2 id="五、防护维度（有什么保护）"><a href="#五、防护维度（有什么保护）" class="headerlink" title="五、防护维度（有什么保护）"></a>五、防护维度（有什么保护）</h2><ul>
<li>终端防护：杀软、EDR、HIDS</li>
<li>网络防护：防火墙、WAF、IPS</li>
<li>访问控制：VPN、零信任、多因素认证</li>
<li>监控覆盖：日志审计、流量监控</li>
<li>实战要点：有部署不等于有效防护，关注防护盲区，日志要能支撑溯源</li>
</ul>
<h2 id="六、行为维度（平时干什么）"><a href="#六、行为维度（平时干什么）" class="headerlink" title="六、行为维度（平时干什么）"></a>六、行为维度（平时干什么）</h2><ul>
<li>通信模式：正常对外连接哪些IP/端口</li>
<li>流量基线：日常流量特征</li>
<li>用户行为：谁在用什么方式访问</li>
<li>实战要点：建立基线需2-4周积累，关注突然出现的行为，可用于威胁狩猎</li>
</ul>
<h2 id="七、信任关系维度（和谁有联系）"><a href="#七、信任关系维度（和谁有联系）" class="headerlink" title="七、信任关系维度（和谁有联系）"></a>七、信任关系维度（和谁有联系）</h2><ul>
<li>横向关联：和哪些内网资产通信</li>
<li>纵向关联：上下游业务依赖</li>
<li>信任路径：从它出发能到达哪些关键资产</li>
<li>实战要点：关注枢纽型资产，横向移动目标是域控/核心数据库，打破内网即信任假设</li>
</ul>
<h1 id="【实施优先级】"><a href="#【实施优先级】" class="headerlink" title="【实施优先级】"></a>【实施优先级】</h1><ul>
<li>第一阶段（1-2月）：身份+暴露面+脆弱性 —— 摸清家底，识别高风险资产</li>
<li>第二阶段（1-2月）：价值+信任关系 —— 建立业务视角，识别关键资产</li>
<li>第三阶段（持续）：防护+行为 —— 完善监控，支撑威胁检测</li>
</ul>
<h1 id="【资产画像数据来源】"><a href="#【资产画像数据来源】" class="headerlink" title="【资产画像数据来源】"></a>【资产画像数据来源】</h1><ul>
<li>自动化采集：nmap/masscan资产发现、Nessus/OpenVAS漏洞扫描、NDR流量分析、SIEM日志平台</li>
<li>人工维护：CMDB资产流程、业务调研访谈、数据分类分级项目</li>
</ul>
<h1 id="【应用场景】"><a href="#【应用场景】" class="headerlink" title="【应用场景】"></a>【应用场景】</h1><ol>
<li>资产清点与合规</li>
<li>漏洞管理优先级</li>
<li>攻防演练与红队评估</li>
<li>应急响应与溯源</li>
<li>安全运营与威胁狩猎</li>
</ol>
<h1 id="【常见挑战与对策】"><a href="#【常见挑战与对策】" class="headerlink" title="【常见挑战与对策】"></a>【常见挑战与对策】</h1><ul>
<li>挑战1：资产数量庞大 → 分阶段推进，优先覆盖核心资产</li>
<li>挑战2：数据质量差 → 多源数据交叉验证，建立校验机制</li>
<li>挑战3：云环境动态变化 → 接入云API实时同步，缩短扫描周期</li>
<li>挑战4：跨部门协作困难 → 建立统一资产平台，明确维护责任</li>
</ul>
<h1 id="【结语】"><a href="#【结语】" class="headerlink" title="【结语】"></a>【结语】</h1><p>资产画像不是一次性项目，而是持续演进的过程。最终目标：知己知彼，百战不殆。<br>当攻击来临时，你能比攻击者更快地回答：</p>
<ul>
<li>哪些资产暴露在互联网上？</li>
<li>哪些资产存在高危漏洞？</li>
<li>哪些资产存储敏感数据？</li>
<li>攻击者可能通过什么路径横向移动？</li>
</ul>
<p>做到这些，你就拥有了防守的主动权。</p>
<hr>
<p>作者博客：<a href="http://xiejava.ishareread.com/">http://xiejava.ishareread.com/</a></p>
<center> 

<br>

<p><img src="http://image2.ishareread.com/images/fullbug%E5%BE%AE%E4%BF%A1%E5%85%AC%E4%BC%97%E5%8F%B7.jpg" alt="“fullbug”微信公众号" title="“fullbug”微信公众号"> </p>
<p>关注：微信公众号,一起学习成长！</center></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://xiejava.ishareread.com/posts/5f421230/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="XieJava">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://img9.doubanio.com/icon/ul70489051-4.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="XieJava's blog">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/posts/5f421230/" itemprop="url">让Claude Code写了个运维健康检查的Skill还挺好用的</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2026-01-20T08:00:00+08:00">
                2026-01-20
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">更新于&#58;</span>
              
              <time title="更新于" itemprop="dateModified" datetime="2026-01-21T23:00:58+08:00">
                2026-01-21
              </time>
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index">
                    <span itemprop="name">技术</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/AI/" itemprop="url" rel="index">
                    <span itemprop="name">AI</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/posts/5f421230/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/posts/5f421230/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/posts/5f421230/" class="leancloud_visitors" data-flag-title="让Claude Code写了个运维健康检查的Skill还挺好用的">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  7.6k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  35
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="摘要"><a href="#摘要" class="headerlink" title="摘要"></a>摘要</h2><p>手头上有几台服务器，经常要对服务器进行健康检查、安全检查等。这几天让ClaudeCode自己写了个Skill这样就一句话活就让AI给干了。本文详细介绍了如何使用Claude Code AI辅助开发工具，从零开始构建一个生产级运维健康检查的Skill。重点阐述了整体架构设计、核心功能实现细节以及实际应用效果。该系统采用模块化设计，提供三大检查模块（基础健康检查、深度安全审计、Docker容器监控），支持双格式输出（Markdown人工可读 + JSON机器可处理），具有良好的可扩展性和兼容性。</p>
<h2 id="一、背景与设计目标"><a href="#一、背景与设计目标" class="headerlink" title="一、背景与设计目标"></a>一、背景与设计目标</h2><h3 id="1-1-实际需求"><a href="#1-1-实际需求" class="headerlink" title="1.1 实际需求"></a>1.1 实际需求</h3><p>在日常运维工作中，我们需要对多台服务器进行健康检查，涵盖系统资源、Docker容器状态、安全指标等多个维度。虽然市面上有很多成熟的监控方案（如Prometheus、Grafana、Zabbix等），但在以下场景中，我们需要一个轻量级、快速部署的检查工具：</p>
<ul>
<li><strong>日常巡检</strong>：每天对服务器进行快速健康扫描</li>
<li><strong>安全审计</strong>：定期检查异常进程、可疑网络连接、文件系统安全</li>
<li><strong>容器监控</strong>：检查Docker容器运行状态、资源使用情况</li>
<li><strong>问题排查</strong>：当系统出现问题时，快速获取当前状态信息</li>
</ul>
<h3 id="1-2-设计目标"><a href="#1-2-设计目标" class="headerlink" title="1.2 设计目标"></a>1.2 设计目标</h3><p>基于上述需求，我设定了以下设计目标交给了Claude Code：</p>
<p><strong>核心特性</strong>：</p>
<ul>
<li>✅ <strong>轻量级部署</strong>：基于Bash脚本，无需额外依赖，远程执行无需安装</li>
<li>✅ <strong>双格式输出</strong>：同时生成Markdown（人工阅读）和JSON（机器处理）格式</li>
<li>✅ <strong>模块化架构</strong>：三大检查模块独立运行，可按需组合</li>
<li>✅ <strong>状态可视化</strong>：使用emoji（✅正常/⚠️警告/❌严重）直观展示</li>
<li>✅ <strong>广泛兼容性</strong>：支持bash 3.2+（macOS默认版本），适配主流Linux发行版</li>
</ul>
<p><strong>技术亮点</strong>：</p>
<ul>
<li>统一的输出库设计，实现代码复用</li>
<li>JSON三层结构（summary/details/metadata），满足不同使用场景</li>
<li>完善的错误处理和兼容性方案</li>
<li>清晰的扩展接口，便于添加新的检查类型</li>
</ul>
<h2 id="二、整体架构设计"><a href="#二、整体架构设计" class="headerlink" title="二、整体架构设计"></a>二、整体架构设计</h2><h3 id="2-1-系统架构"><a href="#2-1-系统架构" class="headerlink" title="2.1 系统架构"></a>2.1 系统架构</h3><p>Claude Code自动帮我设计了整体架构<br>运维健康检查系统采用模块化设计，包含三个独立的检查模块：</p>
<table>
<thead>
<tr>
<th>模块名称</th>
<th>脚本文件</th>
<th>功能定位</th>
<th>核心检查项</th>
</tr>
</thead>
<tbody><tr>
<td><strong>基础健康检查</strong></td>
<td>health-check.sh</td>
<td>日常巡检、快速评估</td>
<td>系统资源、内存、磁盘、网络、服务状态、基础安全</td>
</tr>
<tr>
<td><strong>深度安全检查</strong></td>
<td>security-check.sh</td>
<td>安全审计、威胁检测</td>
<td>异常进程、可疑连接、文件安全、账户安全、系统完整性</td>
</tr>
<tr>
<td><strong>Docker容器监控</strong></td>
<td>docker-check.sh</td>
<td>容器环境管理</td>
<td>容器状态、资源使用、镜像管理、存储空间</td>
</tr>
</tbody></table>
<p><strong>设计原则</strong>：</p>
<ul>
<li><strong>独立性</strong>：每个脚本可单独运行，互不依赖</li>
<li><strong>一致性</strong>：统一的输出格式和状态指示</li>
<li><strong>可扩展性</strong>：易于添加新的检查项或模块</li>
<li><strong>远程友好</strong>：支持SSH管道执行，无需远程安装</li>
</ul>
<h3 id="2-2-文件结构"><a href="#2-2-文件结构" class="headerlink" title="2.2 文件结构"></a>2.2 文件结构</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">host-manage&#x2F;</span><br><span class="line">├── skills&#x2F;ops-health-check&#x2F;</span><br><span class="line">│   ├── SKILL.md                    # Skill定义和使用文档</span><br><span class="line">│   └── scripts&#x2F;</span><br><span class="line">│       ├── health-check.sh         # 基础健康检查脚本</span><br><span class="line">│       ├── security-check.sh       # 深度安全检查脚本</span><br><span class="line">│       ├── docker-check.sh         # Docker监控脚本</span><br><span class="line">│       └── lib&#x2F;</span><br><span class="line">│           └── output.sh           # 输出格式化库（核心）</span><br><span class="line">├── docs&#x2F;plans&#x2F;</span><br><span class="line">│   ├── 2025-01-17-ops-health-check-design.md     # 整体设计文档</span><br><span class="line">│   └── 2025-01-18-json-output-design.md          # JSON输出设计</span><br><span class="line">└── health-reports&#x2F;                 # 检查报告输出目录</span><br><span class="line">    ├── health-check-*.md           # Markdown格式报告</span><br><span class="line">    ├── health-check-*.json         # JSON格式数据</span><br><span class="line">    ├── security-check-*.md</span><br><span class="line">    ├── security-check-*.json</span><br><span class="line">    ├── docker-check-*.md</span><br><span class="line">    └── docker-check-*.json</span><br></pre></td></tr></table></figure>

<h2 id="三、核心功能实现"><a href="#三、核心功能实现" class="headerlink" title="三、核心功能实现"></a>三、核心功能实现</h2><p>Claude Code自动帮我实现了所有的功能</p>
<h3 id="3-1-基础健康检查模块（health-check-sh）"><a href="#3-1-基础健康检查模块（health-check-sh）" class="headerlink" title="3.1 基础健康检查模块（health-check.sh）"></a>3.1 基础健康检查模块（health-check.sh）</h3><p>这是日常运维使用最频繁的模块，专注于快速评估系统整体健康状况。</p>
<h4 id="3-1-1-系统运行时间和负载检查"><a href="#3-1-1-系统运行时间和负载检查" class="headerlink" title="3.1.1 系统运行时间和负载检查"></a>3.1.1 系统运行时间和负载检查</h4><p><strong>检查目的</strong>：了解系统运行时长和当前负载压力</p>
<p><strong>实现逻辑</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 获取系统运行时间</span></span><br><span class="line">uptime_output=$(uptime)</span><br><span class="line">uptime_clean=$(<span class="built_in">echo</span> <span class="string">"<span class="variable">$uptime_output</span>"</span> | sed <span class="string">'s/^ *//g'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 兼容不同系统的uptime输出格式</span></span><br><span class="line">uptime_str=$(uptime -p 2&gt;/dev/null || \</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"<span class="variable">$uptime_clean</span>"</span> | awk -F<span class="string">'up '</span> <span class="string">'&#123;print $2&#125;'</span> | awk -F<span class="string">','</span> <span class="string">'&#123;print $1&#125;'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 提取负载平均值（1分钟、5分钟、15分钟）</span></span><br><span class="line">load_str=$(<span class="built_in">echo</span> <span class="string">"<span class="variable">$uptime_clean</span>"</span> | awk -F<span class="string">'load average:'</span> <span class="string">'&#123;print $2&#125;'</span> | sed <span class="string">'s/^ *//g'</span>)</span><br><span class="line">load_1min=$(<span class="built_in">echo</span> <span class="variable">$load_str</span> | awk <span class="string">'&#123;print $1&#125;'</span> | sed <span class="string">'s/,//'</span>)</span><br><span class="line">load_5min=$(<span class="built_in">echo</span> <span class="variable">$load_str</span> | awk <span class="string">'&#123;print $2&#125;'</span> | sed <span class="string">'s/,//'</span>)</span><br><span class="line">load_15min=$(<span class="built_in">echo</span> <span class="variable">$load_str</span> | awk <span class="string">'&#123;print $3&#125;'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 判断负载状态</span></span><br><span class="line">load_status=$(check_load_status <span class="string">"<span class="variable">$load_1min</span>"</span> <span class="string">"<span class="variable">$CPU_WARNING</span>"</span> <span class="string">"<span class="variable">$CPU_CRITICAL</span>"</span>)</span><br></pre></td></tr></table></figure>

<p><strong>状态判断函数</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">check_load_status</span></span>() &#123;</span><br><span class="line">    <span class="built_in">local</span> load=<span class="variable">$1</span></span><br><span class="line">    <span class="built_in">local</span> warning=<span class="variable">$2</span></span><br><span class="line">    <span class="built_in">local</span> critical=<span class="variable">$3</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 使用bc进行浮点数比较</span></span><br><span class="line">    <span class="keyword">if</span> (( $(<span class="built_in">echo</span> <span class="string">"<span class="variable">$load</span> &gt;= <span class="variable">$critical</span>"</span> | bc -l) )); <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"critical"</span></span><br><span class="line">    <span class="keyword">elif</span> (( $(<span class="built_in">echo</span> <span class="string">"<span class="variable">$load</span> &gt;= <span class="variable">$warning</span>"</span> | bc -l) )); <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"warning"</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"ok"</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>关键点</strong>：</p>
<ul>
<li>使用<code>bc -l</code>进行浮点数比较，兼容不同系统</li>
<li>兼容<code>uptime -p</code>命令（human-readable格式）不可用的情况</li>
<li>同时收集三个时间维度的负载数据，用于趋势分析</li>
</ul>
<h4 id="3-1-2-内存使用检查"><a href="#3-1-2-内存使用检查" class="headerlink" title="3.1.2 内存使用检查"></a>3.1.2 内存使用检查</h4><p><strong>检查目的</strong>：监控内存和swap使用情况，防止内存耗尽</p>
<p><strong>实现逻辑</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 获取内存信息（单位：MB）</span></span><br><span class="line">memory_info=$(free -m | grep Mem)</span><br><span class="line">mem_total=$(<span class="built_in">echo</span> <span class="variable">$memory_info</span> | awk <span class="string">'&#123;print $2&#125;'</span>)</span><br><span class="line">mem_used=$(<span class="built_in">echo</span> <span class="variable">$memory_info</span> | awk <span class="string">'&#123;print $3&#125;'</span>)</span><br><span class="line">mem_avail=$(<span class="built_in">echo</span> <span class="variable">$memory_info</span> | awk <span class="string">'&#123;print $7&#125;'</span>)  <span class="comment"># available列更准确</span></span><br><span class="line">mem_percent=$(awk <span class="string">"BEGIN &#123;printf \"%.1f\", <span class="variable">$mem_used</span> * 100 / <span class="variable">$mem_total</span>&#125;"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Swap检查</span></span><br><span class="line">swap_info=$(free -m | grep Swap)</span><br><span class="line">swap_total=$(<span class="built_in">echo</span> <span class="variable">$swap_info</span> | awk <span class="string">'&#123;print $2&#125;'</span>)</span><br><span class="line">swap_used=$(<span class="built_in">echo</span> <span class="variable">$swap_info</span> | awk <span class="string">'&#123;print $3&#125;'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">"<span class="variable">$swap_total</span>"</span> -gt 0 ]; <span class="keyword">then</span></span><br><span class="line">    swap_percent=$(awk <span class="string">"BEGIN &#123;printf \"%.1f\", <span class="variable">$swap_used</span> * 100 / <span class="variable">$swap_total</span>&#125;"</span>)</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    swap_percent=0</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 状态判断</span></span><br><span class="line"><span class="keyword">if</span> (( $(<span class="built_in">echo</span> <span class="string">"<span class="variable">$mem_percent</span> &gt;= <span class="variable">$MEMORY_CRITICAL</span>"</span> | bc -l) )); <span class="keyword">then</span></span><br><span class="line">    mem_status=<span class="string">"critical"</span></span><br><span class="line"><span class="keyword">elif</span> (( $(<span class="built_in">echo</span> <span class="string">"<span class="variable">$mem_percent</span> &gt;= <span class="variable">$MEMORY_WARNING</span>"</span> | bc -l) )); <span class="keyword">then</span></span><br><span class="line">    mem_status=<span class="string">"warning"</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    mem_status=<span class="string">"ok"</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>

<p><strong>输出示例</strong>：</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">### 内存使用</span></span><br><span class="line"><span class="bullet">- </span><span class="strong">**总内存**</span>: 16384MB</span><br><span class="line"><span class="bullet">- </span><span class="strong">**已使用**</span>: 12500MB (76.3%)</span><br><span class="line"><span class="bullet">- </span><span class="strong">**可用**</span>: 3884MB</span><br><span class="line"><span class="bullet">- </span><span class="strong">**Swap**</span>: 256MB / 2048MB (12.5%)</span><br><span class="line"><span class="bullet">- </span><span class="strong">**状态**</span>: ⚠️ 警告</span><br></pre></td></tr></table></figure>

<p><strong>关键点</strong>：</p>
<ul>
<li>使用<code>free</code>命令的<code>available</code>列而非<code>free</code>列，更准确反映可用内存</li>
<li>同时检查swap使用率，高swap使用率通常意味着内存压力</li>
<li>支持自定义阈值配置（通过环境变量<code>MEMORY_WARNING</code>、<code>MEMORY_CRITICAL</code>）</li>
</ul>
<h4 id="3-1-3-磁盘空间检查"><a href="#3-1-3-磁盘空间检查" class="headerlink" title="3.1.3 磁盘空间检查"></a>3.1.3 磁盘空间检查</h4><p><strong>检查目的</strong>：监控所有挂载点的磁盘使用情况，防止磁盘空间不足</p>
<p><strong>实现逻辑</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">"### 磁盘空间"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"| 挂载点 | 设备 | 容量 | 已用 | 可用 | 使用率 | 状态 |"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"|--------|------|------|------|------|--------|------|"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 遍历所有挂载点（排除临时文件系统）</span></span><br><span class="line">df -h | grep -vE <span class="string">'^Filesystem|tmpfs|overlay|none'</span> | <span class="keyword">while</span> <span class="built_in">read</span> -r line; <span class="keyword">do</span></span><br><span class="line">    device=$(<span class="built_in">echo</span> <span class="variable">$line</span> | awk <span class="string">'&#123;print $1&#125;'</span>)</span><br><span class="line">    size=$(<span class="built_in">echo</span> <span class="variable">$line</span> | awk <span class="string">'&#123;print $2&#125;'</span>)</span><br><span class="line">    used=$(<span class="built_in">echo</span> <span class="variable">$line</span> | awk <span class="string">'&#123;print $3&#125;'</span>)</span><br><span class="line">    avail=$(<span class="built_in">echo</span> <span class="variable">$line</span> | awk <span class="string">'&#123;print $4&#125;'</span>)</span><br><span class="line">    use_percent=$(<span class="built_in">echo</span> <span class="variable">$line</span> | awk <span class="string">'&#123;print $5&#125;'</span> | sed <span class="string">'s/%//'</span>)</span><br><span class="line">    mount=$(<span class="built_in">echo</span> <span class="variable">$line</span> | awk <span class="string">'&#123;print $6&#125;'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 判断状态</span></span><br><span class="line">    <span class="keyword">if</span> [ <span class="string">"<span class="variable">$use_percent</span>"</span> -ge <span class="string">"<span class="variable">$DISK_CRITICAL</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">        status=<span class="string">"critical"</span></span><br><span class="line">        emoji=<span class="string">"❌"</span></span><br><span class="line">    <span class="keyword">elif</span> [ <span class="string">"<span class="variable">$use_percent</span>"</span> -ge <span class="string">"<span class="variable">$DISK_WARNING</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">        status=<span class="string">"warning"</span></span><br><span class="line">        emoji=<span class="string">"⚠️"</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        status=<span class="string">"ok"</span></span><br><span class="line">        emoji=<span class="string">"✅"</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 输出Markdown表格行</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"| <span class="variable">$mount</span> | <span class="variable">$device</span> | <span class="variable">$size</span> | <span class="variable">$used</span> | <span class="variable">$avail</span> | <span class="variable">$&#123;use_percent&#125;</span>% | <span class="variable">$emoji</span> |"</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 收集JSON数据</span></span><br><span class="line">    add_disk_data <span class="string">"<span class="variable">$mount</span>"</span> <span class="string">"device"</span> <span class="string">"<span class="variable">$device</span>"</span></span><br><span class="line">    add_disk_data <span class="string">"<span class="variable">$mount</span>"</span> <span class="string">"total_gb"</span> <span class="string">"<span class="variable">$size</span>"</span></span><br><span class="line">    add_disk_data <span class="string">"<span class="variable">$mount</span>"</span> <span class="string">"used_gb"</span> <span class="string">"<span class="variable">$used</span>"</span></span><br><span class="line">    add_disk_data <span class="string">"<span class="variable">$mount</span>"</span> <span class="string">"available_gb"</span> <span class="string">"<span class="variable">$avail</span>"</span></span><br><span class="line">    add_disk_data <span class="string">"<span class="variable">$mount</span>"</span> <span class="string">"used_percent"</span> <span class="string">"<span class="variable">$use_percent</span>"</span></span><br><span class="line">    add_disk_data <span class="string">"<span class="variable">$mount</span>"</span> <span class="string">"status"</span> <span class="string">"<span class="variable">$status</span>"</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<p><strong>输出示例</strong>：</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">### 磁盘空间</span></span><br><span class="line">| 挂载点 | 设备 | 容量 | 已用 | 可用 | 使用率 | 状态 |</span><br><span class="line">|--------|------|------|------|------|--------|------|</span><br><span class="line">| / | /dev/sda1 | 100G | 45G | 55G | 45.0% | ✅ 正常 |</span><br><span class="line">| /data | /dev/sdb1 | 500G | 425G | 75G | 85.0% | ⚠️ 警告 |</span><br><span class="line">| /boot | /dev/sda2 | 1G | 250M | 750M | 25.0% | ✅ 正常 |</span><br></pre></td></tr></table></figure>

<p><strong>关键点</strong>：</p>
<ul>
<li>自动过滤<code>tmpfs</code>、<code>overlay</code>等临时文件系统</li>
<li>支持多个挂载点，每个挂载点独立判断状态</li>
<li>使用整数比较（已去除百分号），提高性能</li>
<li>同时生成Markdown表格和JSON数组数据</li>
</ul>
<h4 id="3-1-4-网络连接统计"><a href="#3-1-4-网络连接统计" class="headerlink" title="3.1.4 网络连接统计"></a>3.1.4 网络连接统计</h4><p><strong>检查目的</strong>：了解当前网络连接数量，快速发现异常连接</p>
<p><strong>实现逻辑</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用ss命令替代netstat（更现代）</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">command</span> -v ss &gt;/dev/null 2&gt;&amp;1; <span class="keyword">then</span></span><br><span class="line">    <span class="comment"># 总连接数</span></span><br><span class="line">    total_connections=$(ss -tn | wc -l)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 外部连接数（排除本地回环）</span></span><br><span class="line">    external_connections=$(ss -tn | awk <span class="string">'&#123;print $5&#125;'</span> | \</span><br><span class="line">        grep -v <span class="string">'127.0.0.1'</span> | \</span><br><span class="line">        grep -v <span class="string">'::1'</span> | \</span><br><span class="line">        cut -d<span class="string">':'</span> -f1 | \</span><br><span class="line">        sort -u | \</span><br><span class="line">        wc -l)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 监听端口数</span></span><br><span class="line">    listening_ports=$(ss -tln | wc -l)</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="comment"># 降级到netstat</span></span><br><span class="line">    total_connections=$(netstat -tn 2&gt;/dev/null | wc -l)</span><br><span class="line">    external_connections=$(netstat -tn 2&gt;/dev/null | awk <span class="string">'&#123;print $5&#125;'</span> | \</span><br><span class="line">        grep -v <span class="string">'127.0.0.1'</span> | \</span><br><span class="line">        grep -v <span class="string">'::1'</span> | \</span><br><span class="line">        cut -d<span class="string">':'</span> -f1 | \</span><br><span class="line">        sort -u | \</span><br><span class="line">        wc -l)</span><br><span class="line">    listening_ports=$(netstat -tln 2&gt;/dev/null | wc -l)</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">add_system_data <span class="string">"network_total_connections"</span> <span class="string">"<span class="variable">$total_connections</span>"</span></span><br><span class="line">add_system_data <span class="string">"network_external_connections"</span> <span class="string">"<span class="variable">$external_connections</span>"</span></span><br><span class="line">add_system_data <span class="string">"network_listening_ports"</span> <span class="string">"<span class="variable">$listening_ports</span>"</span></span><br></pre></td></tr></table></figure>

<p><strong>关键点</strong>：</p>
<ul>
<li>优先使用<code>ss</code>命令（现代Linux推荐），降级到<code>netstat</code></li>
<li>统计外部独立IP连接数，而非连接总数（更准确反映异常）</li>
<li>包含监听端口数量，便于发现未授权监听</li>
</ul>
<h4 id="3-1-5-systemd服务状态检查"><a href="#3-1-5-systemd服务状态检查" class="headerlink" title="3.1.5 systemd服务状态检查"></a>3.1.5 systemd服务状态检查</h4><p><strong>检查目的</strong>：检查系统服务运行状态，发现失败服务</p>
<p><strong>实现逻辑</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 检查systemd是否可用</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">command</span> -v systemctl &gt;/dev/null 2&gt;&amp;1; <span class="keyword">then</span></span><br><span class="line">    <span class="comment"># 统计服务状态</span></span><br><span class="line">    running_services=$(systemctl list-units --<span class="built_in">type</span>=service --state=running 2&gt;/dev/null | \</span><br><span class="line">        grep <span class="string">'loaded loaded'</span> | wc -l)</span><br><span class="line"></span><br><span class="line">    failed_services=$(systemctl list-units --<span class="built_in">type</span>=service --state=failed 2&gt;/dev/null | \</span><br><span class="line">        grep <span class="string">'loaded loaded'</span> | wc -l)</span><br><span class="line"></span><br><span class="line">    enabled_services=$(systemctl list-unit-files --<span class="built_in">type</span>=service --state=enabled 2&gt;/dev/null | \</span><br><span class="line">        grep <span class="string">'enabled'</span> | wc -l)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 获取失败服务列表</span></span><br><span class="line">    <span class="keyword">if</span> [ <span class="string">"<span class="variable">$failed_services</span>"</span> -gt 0 ]; <span class="keyword">then</span></span><br><span class="line">        failed_list=$(systemctl list-units --<span class="built_in">type</span>=service --state=failed 2&gt;/dev/null | \</span><br><span class="line">            grep <span class="string">'loaded loaded'</span> | awk <span class="string">'&#123;print $1&#125;'</span>)</span><br><span class="line"></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"### 失败的服务"</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"<span class="variable">$failed_list</span>"</span> | <span class="keyword">while</span> <span class="built_in">read</span> -r service; <span class="keyword">do</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">"- ❌ <span class="variable">$service</span>"</span></span><br><span class="line">        <span class="keyword">done</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 常用关键服务检查</span></span><br><span class="line">    critical_services=(<span class="string">"ssh"</span> <span class="string">"docker"</span> <span class="string">"cron"</span> <span class="string">"rsyslog"</span>)</span><br><span class="line">    <span class="keyword">for</span> svc <span class="keyword">in</span> <span class="string">"<span class="variable">$&#123;critical_services[@]&#125;</span>"</span>; <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">if</span> systemctl is-active --quiet <span class="string">"<span class="variable">$&#123;svc&#125;</span>.service"</span> 2&gt;/dev/null; <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">"- ✅ <span class="variable">$&#123;svc&#125;</span>.service: 运行中"</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">"- ⚠️ <span class="variable">$&#123;svc&#125;</span>.service: 未运行或不存在"</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"⚠️ 系统不使用systemd"</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>

<p><strong>输出示例</strong>：</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">### 服务状态</span></span><br><span class="line"><span class="bullet">- </span><span class="strong">**运行中**</span>: 23个</span><br><span class="line"><span class="bullet">- </span><span class="strong">**失败**</span>: 2个</span><br><span class="line"><span class="bullet">- </span><span class="strong">**启用**</span>: 15个</span><br><span class="line"></span><br><span class="line"><span class="section">#### 关键服务状态</span></span><br><span class="line"><span class="bullet">- </span>✅ ssh.service: 运行中</span><br><span class="line"><span class="bullet">- </span>✅ docker.service: 运行中</span><br><span class="line"><span class="bullet">- </span>✅ cron.service: 运行中</span><br><span class="line"><span class="bullet">- </span>❌ postfix.service: 已停止</span><br><span class="line"></span><br><span class="line"><span class="section">#### 失败的服务列表</span></span><br><span class="line"><span class="bullet">- </span>❌ postfix.service</span><br><span class="line"><span class="bullet">- </span>❌ ufw.service</span><br></pre></td></tr></table></figure>

<p><strong>关键点</strong>：</p>
<ul>
<li>兼容非systemd系统（如SysV init）</li>
<li>区分”运行中”、”失败”、”启用”三种状态</li>
<li>单独检查关键服务（SSH、Docker等），便于快速定位问题</li>
<li>列出所有失败服务，方便管理员进一步排查</li>
</ul>
<h4 id="3-1-6-基础安全检查"><a href="#3-1-6-基础安全检查" class="headerlink" title="3.1.6 基础安全检查"></a>3.1.6 基础安全检查</h4><p>虽然主要的安全检查在security-check.sh中，但基础健康检查也包含几个关键的安全指标：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">"### 基础安全"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. 检查挖矿进程</span></span><br><span class="line">MINING_PROCESSES=(<span class="string">"xmrig"</span> <span class="string">"minerd"</span> <span class="string">"cpuminer"</span> <span class="string">"ccminer"</span> <span class="string">"Claymore"</span>)</span><br><span class="line">mining_found=0</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> proc <span class="keyword">in</span> <span class="string">"<span class="variable">$&#123;MINING_PROCESSES[@]&#125;</span>"</span>; <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">if</span> pgrep -x <span class="string">"<span class="variable">$proc</span>"</span> &gt;/dev/null; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"- ❌ 发现挖矿进程: <span class="variable">$proc</span>"</span></span><br><span class="line">        mining_found=1</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$mining_found</span> -eq 0 ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"- ✅ 未发现挖矿进程"</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 检查/tmp和/dev/shm中的可执行文件</span></span><br><span class="line">tmp_execs=$(find /tmp /dev/shm -<span class="built_in">type</span> f -executable 2&gt;/dev/null | wc -l)</span><br><span class="line"><span class="keyword">if</span> [ <span class="string">"<span class="variable">$tmp_execs</span>"</span> -gt 0 ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"- ⚠️ 临时目录中发现 <span class="variable">$tmp_execs</span> 个可执行文件"</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"- ✅ 临时目录无可执行文件"</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 检查失败登录次数（最近）</span></span><br><span class="line"><span class="keyword">if</span> [ -f /var/<span class="built_in">log</span>/auth.log ]; <span class="keyword">then</span></span><br><span class="line">    failed_logins=$(grep <span class="string">"Failed password"</span> /var/<span class="built_in">log</span>/auth.log 2&gt;/dev/null | \</span><br><span class="line">        tail -100 | wc -l)</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"- 最近失败登录次数: <span class="variable">$failed_logins</span>"</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>

<h3 id="3-2-深度安全检查模块（security-check-sh）"><a href="#3-2-深度安全检查模块（security-check-sh）" class="headerlink" title="3.2 深度安全检查模块（security-check.sh）"></a>3.2 深度安全检查模块（security-check.sh）</h3><p>这是最复杂的模块，涵盖了5大类、20+项安全检查，用于全面的安全审计。</p>
<h4 id="3-2-1-异常进程检测"><a href="#3-2-1-异常进程检测" class="headerlink" title="3.2.1 异常进程检测"></a>3.2.1 异常进程检测</h4><p><strong>检查目的</strong>：发现挖矿程序、高资源占用进程、可疑可执行文件</p>
<p><strong>1. 挖矿进程检测</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 定义已知挖矿程序名称列表</span></span><br><span class="line">MINING_PROCESSES=(</span><br><span class="line">    <span class="string">"xmrig"</span> <span class="string">"minerd"</span> <span class="string">"cpuminer"</span> <span class="string">"ccminer"</span> <span class="string">"Claymore"</span></span><br><span class="line">    <span class="string">"cryptonight"</span> <span class="string">"ethminer"</span> <span class="string">"nbminer"</span> <span class="string">"bminer"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">suspicious_procs=<span class="string">""</span></span><br><span class="line">mining_detected=<span class="string">"false"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 遍历检查</span></span><br><span class="line"><span class="keyword">for</span> proc <span class="keyword">in</span> <span class="string">"<span class="variable">$&#123;MINING_PROCESSES[@]&#125;</span>"</span>; <span class="keyword">do</span></span><br><span class="line">    <span class="comment"># 使用pgrep查找进程（比ps aux更快）</span></span><br><span class="line">    found=$(pgrep -ix <span class="string">"<span class="variable">$proc</span>"</span> 2&gt;/dev/null)</span><br><span class="line">    <span class="keyword">if</span> [ -n <span class="string">"<span class="variable">$found</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="comment"># 获取进程详细信息</span></span><br><span class="line">        proc_info=$(ps -p <span class="string">"<span class="variable">$found</span>"</span> -o pid,user,cmd --no-headers 2&gt;/dev/null)</span><br><span class="line">        suspicious_procs=<span class="string">"<span class="variable">$suspicious_procs</span>\n<span class="variable">$proc_info</span>"</span></span><br><span class="line">        mining_detected=<span class="string">"true"</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 记录到安全数据</span></span><br><span class="line">        add_security_data <span class="string">"mining_process"</span> <span class="string">"<span class="variable">$proc</span>"</span></span><br><span class="line">        add_security_data <span class="string">"mining_pid"</span> <span class="string">"<span class="variable">$found</span>"</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">"<span class="variable">$mining_detected</span>"</span> = <span class="string">"true"</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"❌ 发现挖矿进程："</span></span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">"<span class="variable">$suspicious_procs</span>"</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"✅ 未发现挖矿进程"</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>

<p><strong>2. 高资源占用进程检测</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">"### 高资源占用进程（Top 10）"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"| PID | 用户 | CPU% | 内存% | 命令 |"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"|-----|------|------|--------|------|"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># CPU占用最高的进程</span></span><br><span class="line">ps aux --sort=-%cpu | head -n 11 | tail -n 10 | <span class="keyword">while</span> <span class="built_in">read</span> -r line; <span class="keyword">do</span></span><br><span class="line">    pid=$(<span class="built_in">echo</span> <span class="string">"<span class="variable">$line</span>"</span> | awk <span class="string">'&#123;print $2&#125;'</span>)</span><br><span class="line">    user=$(<span class="built_in">echo</span> <span class="string">"<span class="variable">$line</span>"</span> | awk <span class="string">'&#123;print $1&#125;'</span>)</span><br><span class="line">    cpu=$(<span class="built_in">echo</span> <span class="string">"<span class="variable">$line</span>"</span> | awk <span class="string">'&#123;print $3&#125;'</span>)</span><br><span class="line">    mem=$(<span class="built_in">echo</span> <span class="string">"<span class="variable">$line</span>"</span> | awk <span class="string">'&#123;print $4&#125;'</span>)</span><br><span class="line">    cmd=$(<span class="built_in">echo</span> <span class="string">"<span class="variable">$line</span>"</span> | awk <span class="string">'&#123;for(i=11;i&lt;=NF;i++)printf $i" "&#125;'</span> | cut -c1-50)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 标记异常高占用</span></span><br><span class="line">    <span class="keyword">if</span> (( $(<span class="built_in">echo</span> <span class="string">"<span class="variable">$cpu</span> &gt; 80"</span> | bc -l) )); <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"| <span class="variable">$pid</span> | <span class="variable">$user</span> | **<span class="variable">$cpu</span>** | <span class="variable">$mem</span> | <span class="variable">$cmd</span> |"</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"| <span class="variable">$pid</span> | <span class="variable">$user</span> | <span class="variable">$cpu</span> | <span class="variable">$mem</span> | <span class="variable">$cmd</span> |"</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<p><strong>3. 临时目录可执行文件检查</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 检查/tmp和/dev/shm中的可执行文件</span></span><br><span class="line">tmp_dirs=(<span class="string">"/tmp"</span> <span class="string">"/dev/shm"</span> <span class="string">"/var/tmp"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> dir <span class="keyword">in</span> <span class="string">"<span class="variable">$&#123;tmp_dirs[@]&#125;</span>"</span>; <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">if</span> [ -d <span class="string">"<span class="variable">$dir</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">        exec_files=$(find <span class="string">"<span class="variable">$dir</span>"</span> -<span class="built_in">type</span> f -executable 2&gt;/dev/null)</span><br><span class="line">        exec_count=$(<span class="built_in">echo</span> <span class="string">"<span class="variable">$exec_files</span>"</span> | grep -v <span class="string">'^$'</span> | wc -l)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> [ <span class="string">"<span class="variable">$exec_count</span>"</span> -gt 0 ]; <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">"⚠️ <span class="variable">$dir</span> 中发现 <span class="variable">$exec_count</span> 个可执行文件："</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">"<span class="variable">$exec_files</span>"</span> | head -n 10 | <span class="keyword">while</span> <span class="built_in">read</span> -r file; <span class="keyword">do</span></span><br><span class="line">                perms=$(<span class="built_in">stat</span> -c <span class="string">"%a"</span> <span class="string">"<span class="variable">$file</span>"</span> 2&gt;/dev/null)</span><br><span class="line">                size=$(<span class="built_in">stat</span> -c <span class="string">"%s"</span> <span class="string">"<span class="variable">$file</span>"</span> 2&gt;/dev/null)</span><br><span class="line">                mtime=$(<span class="built_in">stat</span> -c <span class="string">"%y"</span> <span class="string">"<span class="variable">$file</span>"</span> 2&gt;/dev/null | cut -d<span class="string">'.'</span> -f1)</span><br><span class="line">                <span class="built_in">echo</span> <span class="string">"  - <span class="variable">$file</span> (权限:<span class="variable">$perms</span>, 大小:<span class="variable">$size</span>字节, 修改:<span class="variable">$mtime</span>)"</span></span><br><span class="line">            <span class="keyword">done</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<p><strong>关键点</strong>：</p>
<ul>
<li>使用<code>pgrep</code>而非<code>ps aux | grep</code>，性能更高且避免误匹配</li>
<li>记录进程的PID、用户、完整命令行，便于追踪</li>
<li>同时检查/tmp、/dev/shm、/var/tmp三个常见临时目录</li>
<li>显示文件的权限、大小、修改时间，帮助判断是否可疑</li>
</ul>
<h4 id="3-2-2-网络安全检查"><a href="#3-2-2-网络安全检查" class="headerlink" title="3.2.2 网络安全检查"></a>3.2.2 网络安全检查</h4><p><strong>检查目的</strong>：发现反向shell、可疑端口监听、异常外部连接</p>
<p><strong>1. 反向shell检测</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 反向shell典型特征：外部IP连接本地高端口（非标准服务端口）</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"### 反向shell检测"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取所有TCP连接</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">command</span> -v ss &gt;/dev/null 2&gt;&amp;1; <span class="keyword">then</span></span><br><span class="line">    connections=$(ss -tnp 2&gt;/dev/null)</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    connections=$(netstat -tnp 2&gt;/dev/null)</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 检测可疑模式：外部IP连接到本地50000-65535端口</span></span><br><span class="line">reverse_shell_detected=<span class="string">"false"</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$connections</span>"</span> | <span class="keyword">while</span> <span class="built_in">read</span> -r line; <span class="keyword">do</span></span><br><span class="line">    <span class="comment"># 解析本地地址和远程地址</span></span><br><span class="line">    local_addr=$(<span class="built_in">echo</span> <span class="string">"<span class="variable">$line</span>"</span> | awk <span class="string">'&#123;print $4&#125;'</span>)</span><br><span class="line">    remote_addr=$(<span class="built_in">echo</span> <span class="string">"<span class="variable">$line</span>"</span> | awk <span class="string">'&#123;print $5&#125;'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 提取端口号</span></span><br><span class="line">    local_port=$(<span class="built_in">echo</span> <span class="string">"<span class="variable">$local_addr</span>"</span> | cut -d<span class="string">':'</span> -f2 | cut -d<span class="string">':'</span> -f1)</span><br><span class="line">    remote_ip=$(<span class="built_in">echo</span> <span class="string">"<span class="variable">$remote_addr</span>"</span> | cut -d<span class="string">':'</span> -f1)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 排除本地回环和标准端口</span></span><br><span class="line">    <span class="keyword">if</span> [[ ! <span class="string">"<span class="variable">$remote_ip</span>"</span> =~ ^(127\.|::1) ]]; <span class="keyword">then</span></span><br><span class="line">        <span class="comment"># 检查本地端口是否为高端口（非标准服务）</span></span><br><span class="line">        <span class="keyword">if</span> [ <span class="string">"<span class="variable">$local_port</span>"</span> -ge 50000 ] 2&gt;/dev/null; <span class="keyword">then</span></span><br><span class="line">            <span class="comment"># 排除部分合法的高端口号</span></span><br><span class="line">            <span class="keyword">if</span> [[ ! <span class="string">"<span class="variable">$local_port</span>"</span> =~ ^(50000|50001|50002) ]]; <span class="keyword">then</span></span><br><span class="line">                <span class="built_in">echo</span> <span class="string">"⚠️ 可疑连接：远程 <span class="variable">$remote_addr</span> -&gt; 本地端口 <span class="variable">$local_port</span>"</span></span><br><span class="line">                reverse_shell_detected=<span class="string">"true"</span></span><br><span class="line">            <span class="keyword">fi</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">"<span class="variable">$reverse_shell_detected</span>"</span> = <span class="string">"false"</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"✅ 未发现反向shell特征"</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>

<p><strong>2. 监听端口分析</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">"### 监听端口分析"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取所有监听端口</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">command</span> -v ss &gt;/dev/null 2&gt;&amp;1; <span class="keyword">then</span></span><br><span class="line">    listening=$(ss -tulpn 2&gt;/dev/null)</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    listening=$(netstat -tulpn 2&gt;/dev/null)</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"| 端口 | 协议 | 进程 | 用户 |"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"|------|------|------|------|"</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$listening</span>"</span> | grep LISTEN | <span class="keyword">while</span> <span class="built_in">read</span> -r line; <span class="keyword">do</span></span><br><span class="line">    port=$(<span class="built_in">echo</span> <span class="string">"<span class="variable">$line</span>"</span> | awk <span class="string">'&#123;print $5&#125;'</span> | rev | cut -d<span class="string">':'</span> -f1 | rev)</span><br><span class="line">    protocol=$(<span class="built_in">echo</span> <span class="string">"<span class="variable">$line</span>"</span> | awk <span class="string">'&#123;print $1&#125;'</span>)</span><br><span class="line">    process=$(<span class="built_in">echo</span> <span class="string">"<span class="variable">$line</span>"</span> | awk <span class="string">'&#123;print $7&#125;'</span> | cut -d<span class="string">'/'</span> -f2 | cut -d<span class="string">','</span> -f1)</span><br><span class="line">    user=$(<span class="built_in">echo</span> <span class="string">"<span class="variable">$line</span>"</span> | awk <span class="string">'&#123;print $7&#125;'</span> | cut -d<span class="string">'"'</span> -f2)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 标记非标准高端口</span></span><br><span class="line">    <span class="keyword">if</span> [ <span class="string">"<span class="variable">$port</span>"</span> -ge 10000 ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"| **<span class="variable">$port</span>** | <span class="variable">$protocol</span> | <span class="variable">$process</span> | <span class="variable">$user</span> |"</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"| <span class="variable">$port</span> | <span class="variable">$protocol</span> | <span class="variable">$process</span> | <span class="variable">$user</span> |"</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<p><strong>3. 外部连接统计</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 统计外部连接的独立IP数量</span></span><br><span class="line">external_ips=$(ss -tn 2&gt;/dev/null | \</span><br><span class="line">    awk <span class="string">'&#123;print $5&#125;'</span> | \</span><br><span class="line">    cut -d<span class="string">':'</span> -f1 | \</span><br><span class="line">    grep -vE <span class="string">'^(127\.|::1|0\.0\.0\.0)'</span> | \</span><br><span class="line">    sort -u | \</span><br><span class="line">    wc -l)</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"### 外部连接统计"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"- 外部连接的独立IP数：<span class="variable">$external_ips</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 列出Top 10外部IP</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"- 连接最多的外部IP："</span></span><br><span class="line">ss -tn 2&gt;/dev/null | \</span><br><span class="line">    awk <span class="string">'&#123;print $5&#125;'</span> | \</span><br><span class="line">    cut -d<span class="string">':'</span> -f1 | \</span><br><span class="line">    grep -vE <span class="string">'^(127\.|::1|0\.0\.0\.0)'</span> | \</span><br><span class="line">    sort | uniq -c | sort -rn | head -n 10 | \</span><br><span class="line">    <span class="keyword">while</span> <span class="built_in">read</span> -r line; <span class="keyword">do</span></span><br><span class="line">        count=$(<span class="built_in">echo</span> <span class="string">"<span class="variable">$line</span>"</span> | awk <span class="string">'&#123;print $1&#125;'</span>)</span><br><span class="line">        ip=$(<span class="built_in">echo</span> <span class="string">"<span class="variable">$line</span>"</span> | awk <span class="string">'&#123;print $2&#125;'</span>)</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"  - <span class="variable">$ip</span>: <span class="variable">$count</span> 次连接"</span></span><br><span class="line">    <span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<p><strong>关键点</strong>：</p>
<ul>
<li>反向shell检测基于行为特征：外部IP连接本地高端口</li>
<li>排除已知的合法高端口（如某些应用服务）</li>
<li>统计外部连接IP数量和连接频率，异常高值需要关注</li>
<li>显示监听端口对应的进程和用户，便于排查</li>
</ul>
<h4 id="3-2-3-文件系统安全检查"><a href="#3-2-3-文件系统安全检查" class="headerlink" title="3.2.3 文件系统安全检查"></a>3.2.3 文件系统安全检查</h4><p><strong>检查目的</strong>：发现最近修改的敏感文件、勒索病毒特征、SUID/SGID文件</p>
<p><strong>1. 关键目录变更检测</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">"### 关键目录最近变更（7天内）"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义需要监控的关键目录</span></span><br><span class="line">critical_dirs=(<span class="string">"/etc"</span> <span class="string">"/home"</span> <span class="string">"/root"</span> <span class="string">"/var/www"</span> <span class="string">"/opt"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> dir <span class="keyword">in</span> <span class="string">"<span class="variable">$&#123;critical_dirs[@]&#125;</span>"</span>; <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">if</span> [ -d <span class="string">"<span class="variable">$dir</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="comment"># 查找7天内修改的文件</span></span><br><span class="line">        recent_files=$(find <span class="string">"<span class="variable">$dir</span>"</span> -<span class="built_in">type</span> f -mtime -7 2&gt;/dev/null)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> [ -n <span class="string">"<span class="variable">$recent_files</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">            file_count=$(<span class="built_in">echo</span> <span class="string">"<span class="variable">$recent_files</span>"</span> | grep -v <span class="string">'^$'</span> | wc -l)</span><br><span class="line">            <span class="built_in">echo</span> <span class="string">"⚠️ <span class="variable">$dir</span>: <span class="variable">$file_count</span> 个文件在最近7天被修改"</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># 显示部分关键文件</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">"<span class="variable">$recent_files</span>"</span> | head -n 5 | <span class="keyword">while</span> <span class="built_in">read</span> -r file; <span class="keyword">do</span></span><br><span class="line">                perms=$(<span class="built_in">stat</span> -c <span class="string">"%a"</span> <span class="string">"<span class="variable">$file</span>"</span> 2&gt;/dev/null)</span><br><span class="line">                <span class="built_in">echo</span> <span class="string">"  - <span class="variable">$file</span> (权限:<span class="variable">$perms</span>)"</span></span><br><span class="line">            <span class="keyword">done</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<p><strong>2. 勒索病毒特征检测</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">"### 勒索病毒特征检测"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义勒索病毒常用的文件扩展名</span></span><br><span class="line">ransomware_patterns=(</span><br><span class="line">    <span class="string">"*.encrypted"</span></span><br><span class="line">    <span class="string">"*.locked"</span></span><br><span class="line">    <span class="string">"*.crypto"</span></span><br><span class="line">    <span class="string">"*.crypt"</span></span><br><span class="line">    <span class="string">"*.crypted"</span></span><br><span class="line">    <span class="string">"*_README.txt"</span></span><br><span class="line">    <span class="string">"*_DECRYPT.txt"</span></span><br><span class="line">    <span class="string">"*_HELP.txt"</span></span><br><span class="line">    <span class="string">"*_RESTORE.txt"</span></span><br><span class="line">    <span class="string">"how_to_decrypt.*"</span></span><br><span class="line">    <span class="string">"recover_files.*"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">ransomware_found=<span class="string">"false"</span></span><br><span class="line"><span class="keyword">for</span> pattern <span class="keyword">in</span> <span class="string">"<span class="variable">$&#123;ransomware_patterns[@]&#125;</span>"</span>; <span class="keyword">do</span></span><br><span class="line">    <span class="comment"># 在用户目录中查找</span></span><br><span class="line">    found_files=$(find /home /root -name <span class="string">"<span class="variable">$pattern</span>"</span> 2&gt;/dev/null)</span><br><span class="line">    <span class="keyword">if</span> [ -n <span class="string">"<span class="variable">$found_files</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"❌ 发现勒索病毒特征文件："</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"<span class="variable">$found_files</span>"</span> | head -n 10</span><br><span class="line">        ransomware_found=<span class="string">"true"</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">"<span class="variable">$ransomware_found</span>"</span> = <span class="string">"false"</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"✅ 未发现勒索病毒特征"</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>

<p><strong>3. SUID/SGID文件检查</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">"### SUID/SGID文件检查"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查找所有SUID文件</span></span><br><span class="line">suid_files=$(find / -<span class="built_in">type</span> f -perm -4000 2&gt;/dev/null | \</span><br><span class="line">    grep -v -E <span class="string">'^/proc|^/sys|^/dev'</span> | \</span><br><span class="line">    head -n 30)</span><br><span class="line"></span><br><span class="line">suid_count=$(<span class="built_in">echo</span> <span class="string">"<span class="variable">$suid_files</span>"</span> | grep -v <span class="string">'^$'</span> | wc -l)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">"<span class="variable">$suid_count</span>"</span> -gt 0 ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"发现 <span class="variable">$suid_count</span> 个SUID文件（部分列表）："</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"<span class="variable">$suid_files</span>"</span> | <span class="keyword">while</span> <span class="built_in">read</span> -r file; <span class="keyword">do</span></span><br><span class="line">        perms=$(<span class="built_in">stat</span> -c <span class="string">"%a"</span> <span class="string">"<span class="variable">$file</span>"</span> 2&gt;/dev/null)</span><br><span class="line">        owner=$(<span class="built_in">stat</span> -c <span class="string">"%U"</span> <span class="string">"<span class="variable">$file</span>"</span> 2&gt;/dev/null)</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"  - <span class="variable">$file</span> (权限:<span class="variable">$perms</span>, 所有者:<span class="variable">$owner</span>)"</span></span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查找所有SGID文件</span></span><br><span class="line">sgid_files=$(find / -<span class="built_in">type</span> f -perm -2000 2&gt;/dev/null | \</span><br><span class="line">    grep -v -E <span class="string">'^/proc|^/sys|^/dev'</span> | \</span><br><span class="line">    head -n 20)</span><br><span class="line"></span><br><span class="line">sgid_count=$(<span class="built_in">echo</span> <span class="string">"<span class="variable">$sgid_files</span>"</span> | grep -v <span class="string">'^$'</span> | wc -l)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">"<span class="variable">$sgid_count</span>"</span> -gt 0 ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"发现 <span class="variable">$sgid_count</span> 个SGID文件（部分列表）："</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"<span class="variable">$sgid_files</span>"</span> | <span class="keyword">while</span> <span class="built_in">read</span> -r file; <span class="keyword">do</span></span><br><span class="line">        perms=$(<span class="built_in">stat</span> -c <span class="string">"%a"</span> <span class="string">"<span class="variable">$file</span>"</span> 2&gt;/dev/null)</span><br><span class="line">        owner=$(<span class="built_in">stat</span> -c <span class="string">"%U"</span> <span class="string">"<span class="variable">$file</span>"</span> 2&gt;/dev/null)</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"  - <span class="variable">$file</span> (权限:<span class="variable">$perms</span>, 所有者:<span class="variable">$owner</span>)"</span></span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>

<p><strong>关键点</strong>：</p>
<ul>
<li>重点监控/etc、/home、/root等敏感目录</li>
<li>勒索病毒检测基于文件扩展名特征（实际环境中建议结合文件内容分析）</li>
<li>SUID/SGID文件是提权漏洞的常见切入点，需要重点关注</li>
<li>限制输出数量，避免报告过长</li>
</ul>
<h4 id="3-2-4-账户和登录安全检查"><a href="#3-2-4-账户和登录安全检查" class="headerlink" title="3.2.4 账户和登录安全检查"></a>3.2.4 账户和登录安全检查</h4><p><strong>检查目的</strong>：检测异常登录、新增用户、sudo使用情况</p>
<p><strong>1. 最近登录记录</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">"### 最近登录记录（最近10次）"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用last命令获取登录记录</span></span><br><span class="line">recent_logins=$(last -n 10 -a 2&gt;/dev/null | head -n -2)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ -n <span class="string">"<span class="variable">$recent_logins</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"| 用户 | 终端 | 来源IP | 登录时间 |"</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"|------|------|--------|----------|"</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"<span class="variable">$recent_logins</span>"</span> | <span class="keyword">while</span> <span class="built_in">read</span> -r line; <span class="keyword">do</span></span><br><span class="line">        user=$(<span class="built_in">echo</span> <span class="string">"<span class="variable">$line</span>"</span> | awk <span class="string">'&#123;print $1&#125;'</span>)</span><br><span class="line">        terminal=$(<span class="built_in">echo</span> <span class="string">"<span class="variable">$line</span>"</span> | awk <span class="string">'&#123;print $2&#125;'</span>)</span><br><span class="line">        <span class="comment"># IP在最后，主机名倒数第二</span></span><br><span class="line">        ip=$(<span class="built_in">echo</span> <span class="string">"<span class="variable">$line</span>"</span> | awk <span class="string">'&#123;print $(NF-1)&#125;'</span> | sed <span class="string">'s/(//g'</span>)</span><br><span class="line">        <span class="comment"># 时间范围在中间部分</span></span><br><span class="line">        time_range=$(<span class="built_in">echo</span> <span class="string">"<span class="variable">$line</span>"</span> | awk <span class="string">'&#123;for(i=3;i&lt;=NF-2;i++)printf $i" "&#125;'</span>)</span><br><span class="line"></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"| <span class="variable">$user</span> | <span class="variable">$terminal</span> | <span class="variable">$ip</span> | <span class="variable">$time_range</span> |"</span></span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>

<p><strong>2. 失败登录统计</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">"### 失败登录统计"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 统计最近失败的登录次数</span></span><br><span class="line"><span class="keyword">if</span> [ -f /var/<span class="built_in">log</span>/auth.log ]; <span class="keyword">then</span></span><br><span class="line">    <span class="comment"># Debian/Ubuntu系统</span></span><br><span class="line">    failed_count=$(grep <span class="string">"Failed password"</span> /var/<span class="built_in">log</span>/auth.log 2&gt;/dev/null | \</span><br><span class="line">        tail -1000 | wc -l)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"- 最近失败登录次数（最近1000条日志）：<span class="variable">$failed_count</span>"</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 统计失败登录来源IP</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"- 失败登录最多的IP："</span></span><br><span class="line">    grep <span class="string">"Failed password"</span> /var/<span class="built_in">log</span>/auth.log 2&gt;/dev/null | \</span><br><span class="line">        awk <span class="string">'&#123;print $13&#125;'</span> | \</span><br><span class="line">        sort | uniq -c | sort -rn | head -n 5 | \</span><br><span class="line">        <span class="keyword">while</span> <span class="built_in">read</span> -r line; <span class="keyword">do</span></span><br><span class="line">            count=$(<span class="built_in">echo</span> <span class="string">"<span class="variable">$line</span>"</span> | awk <span class="string">'&#123;print $1&#125;'</span>)</span><br><span class="line">            ip=$(<span class="built_in">echo</span> <span class="string">"<span class="variable">$line</span>"</span> | awk <span class="string">'&#123;print $2&#125;'</span>)</span><br><span class="line">            <span class="built_in">echo</span> <span class="string">"  - <span class="variable">$ip</span>: <span class="variable">$count</span> 次"</span></span><br><span class="line">        <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">elif</span> [ -f /var/<span class="built_in">log</span>/secure ]; <span class="keyword">then</span></span><br><span class="line">    <span class="comment"># CentOS/RHEL系统</span></span><br><span class="line">    failed_count=$(grep <span class="string">"Failed password"</span> /var/<span class="built_in">log</span>/secure 2&gt;/dev/null | \</span><br><span class="line">        tail -1000 | wc -l)</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"- 最近失败登录次数（最近1000条日志）：<span class="variable">$failed_count</span>"</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>

<p><strong>3. 新增用户检测</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">"### 新增用户检测（最近30天）"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查shadow文件中最近修改的用户</span></span><br><span class="line"><span class="keyword">if</span> [ -f /etc/shadow ]; <span class="keyword">then</span></span><br><span class="line">    <span class="comment"># 第4字段是最后修改时间（天数，从1970-01-01起）</span></span><br><span class="line">    thirty_days_ago=$(($(date +%s) / 86400 - 30))</span><br><span class="line"></span><br><span class="line">    new_users=$(awk -F: -v date=<span class="string">"<span class="variable">$thirty_days_ago</span>"</span> \</span><br><span class="line">        <span class="string">'$4 &gt;= date &#123;print $1&#125;'</span> /etc/shadow 2&gt;/dev/null)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> [ -n <span class="string">"<span class="variable">$new_users</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"⚠️ 发现最近30天新增的用户："</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"<span class="variable">$new_users</span>"</span> | <span class="keyword">while</span> <span class="built_in">read</span> -r user; <span class="keyword">do</span></span><br><span class="line">            <span class="comment"># 获取用户详细信息</span></span><br><span class="line">            user_info=$(grep <span class="string">"^<span class="variable">$user</span>:"</span> /etc/passwd)</span><br><span class="line">            uid=$(<span class="built_in">echo</span> <span class="string">"<span class="variable">$user_info</span>"</span> | cut -d<span class="string">':'</span> -f3)</span><br><span class="line">            home=$(<span class="built_in">echo</span> <span class="string">"<span class="variable">$user_info</span>"</span> | cut -d<span class="string">':'</span> -f6)</span><br><span class="line">            shell=$(<span class="built_in">echo</span> <span class="string">"<span class="variable">$user_info</span>"</span> | cut -d<span class="string">':'</span> -f7)</span><br><span class="line">            <span class="built_in">echo</span> <span class="string">"  - <span class="variable">$user</span> (UID:<span class="variable">$uid</span>, HOME:<span class="variable">$home</span>, SHELL:<span class="variable">$shell</span>)"</span></span><br><span class="line">        <span class="keyword">done</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"✅ 未发现最近30天的新增用户"</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>

<p><strong>4. Sudo使用审计</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">"### Sudo使用审计（最近20条）"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查sudo日志</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">command</span> -v journalctl &gt;/dev/null 2&gt;&amp;1; <span class="keyword">then</span></span><br><span class="line">    <span class="comment"># 使用journalctl读取sudo日志</span></span><br><span class="line">    sudo_logs=$(journalctl -u sudo 2&gt;/dev/null | tail -n 20)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> [ -n <span class="string">"<span class="variable">$sudo_logs</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"<span class="variable">$sudo_logs</span>"</span> | <span class="keyword">while</span> <span class="built_in">read</span> -r line; <span class="keyword">do</span></span><br><span class="line">            <span class="comment"># 提取关键信息：时间、用户、命令</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">"  - <span class="variable">$line</span>"</span></span><br><span class="line">        <span class="keyword">done</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">elif</span> [ -f /var/<span class="built_in">log</span>/auth.log ]; <span class="keyword">then</span></span><br><span class="line">    <span class="comment"># 从auth.log中提取sudo记录</span></span><br><span class="line">    sudo_logs=$(grep sudo /var/<span class="built_in">log</span>/auth.log 2&gt;/dev/null | tail -n 20)</span><br><span class="line">    <span class="keyword">if</span> [ -n <span class="string">"<span class="variable">$sudo_logs</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"<span class="variable">$sudo_logs</span>"</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>

<p><strong>关键点</strong>：</p>
<ul>
<li>兼容不同Linux发行版的日志文件路径</li>
<li>统计失败登录次数和来源IP，高值可能意味着暴力破解</li>
<li>检测新增用户，特别是UID为0（root权限）的用户</li>
<li>审计sudo使用情况，发现权限滥用</li>
</ul>
<h4 id="3-2-5-系统完整性检查"><a href="#3-2-5-系统完整性检查" class="headerlink" title="3.2.5 系统完整性检查"></a>3.2.5 系统完整性检查</h4><p><strong>检查目的</strong>：检查关键文件权限、系统二进制文件完整性</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">"### 系统完整性检查"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义关键文件列表</span></span><br><span class="line">critical_files=(</span><br><span class="line">    <span class="string">"/etc/passwd"</span></span><br><span class="line">    <span class="string">"/etc/shadow"</span></span><br><span class="line">    <span class="string">"/etc/sudoers"</span></span><br><span class="line">    <span class="string">"/etc/ssh/sshd_config"</span></span><br><span class="line">    <span class="string">"/etc/ssh/ssh_host_*_key"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"| 文件 | 权限 | 所有者 | 组 | 状态 |"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"|------|------|--------|-----|------|"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> file <span class="keyword">in</span> <span class="string">"<span class="variable">$&#123;critical_files[@]&#125;</span>"</span>; <span class="keyword">do</span></span><br><span class="line">    <span class="comment"># 使用通配符展开</span></span><br><span class="line">    <span class="keyword">for</span> expanded_file <span class="keyword">in</span> <span class="variable">$file</span>; <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">if</span> [ -e <span class="string">"<span class="variable">$expanded_file</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">            perms=$(<span class="built_in">stat</span> -c <span class="string">"%a"</span> <span class="string">"<span class="variable">$expanded_file</span>"</span> 2&gt;/dev/null || <span class="built_in">stat</span> -f <span class="string">"%OLp"</span> <span class="string">"<span class="variable">$expanded_file</span>"</span> 2&gt;/dev/null)</span><br><span class="line">            owner=$(<span class="built_in">stat</span> -c <span class="string">"%U"</span> <span class="string">"<span class="variable">$expanded_file</span>"</span> 2&gt;/dev/null || <span class="built_in">stat</span> -f <span class="string">"%Su"</span> <span class="string">"<span class="variable">$expanded_file</span>"</span> 2&gt;/dev/null)</span><br><span class="line">            group=$(<span class="built_in">stat</span> -c <span class="string">"%G"</span> <span class="string">"<span class="variable">$expanded_file</span>"</span> 2&gt;/dev/null || <span class="built_in">stat</span> -f <span class="string">"%Sg"</span> <span class="string">"<span class="variable">$expanded_file</span>"</span> 2&gt;/dev/null)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 检查权限是否合适（简化判断）</span></span><br><span class="line">            status=<span class="string">"✅"</span></span><br><span class="line">            <span class="keyword">case</span> <span class="string">"<span class="variable">$(basename "$expanded_file")</span>"</span> <span class="keyword">in</span></span><br><span class="line">                shadow)</span><br><span class="line">                    <span class="keyword">if</span> [ <span class="string">"<span class="variable">$perms</span>"</span> != <span class="string">"000"</span> ] &amp;&amp; [ <span class="string">"<span class="variable">$perms</span>"</span> != <span class="string">"640"</span> ]; <span class="keyword">then</span></span><br><span class="line">                        status=<span class="string">"⚠️"</span></span><br><span class="line">                    <span class="keyword">fi</span></span><br><span class="line">                    ;;</span><br><span class="line">                sudoers)</span><br><span class="line">                    <span class="keyword">if</span> [ <span class="string">"<span class="variable">$perms</span>"</span> != <span class="string">"440"</span> ] &amp;&amp; [ <span class="string">"<span class="variable">$perms</span>"</span> != <span class="string">"400"</span> ]; <span class="keyword">then</span></span><br><span class="line">                        status=<span class="string">"⚠️"</span></span><br><span class="line">                    <span class="keyword">fi</span></span><br><span class="line">                    ;;</span><br><span class="line">            <span class="keyword">esac</span></span><br><span class="line"></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">"| <span class="variable">$expanded_file</span> | <span class="variable">$perms</span> | <span class="variable">$owner</span> | <span class="variable">$group</span> | <span class="variable">$status</span> |"</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<p><strong>关键点</strong>：</p>
<ul>
<li>重点检查/etc/passwd、/etc/shadow等认证相关文件</li>
<li>/etc/shadow应该是000或640权限</li>
<li>/etc/sudoers应该是440或400权限</li>
<li>SSH私钥文件应该是600或400权限</li>
</ul>
<h3 id="3-3-Docker容器监控模块（docker-check-sh）"><a href="#3-3-Docker容器监控模块（docker-check-sh）" class="headerlink" title="3.3 Docker容器监控模块（docker-check.sh）"></a>3.3 Docker容器监控模块（docker-check.sh）</h3><p>专注于Docker环境的健康检查和资源监控。</p>
<h4 id="3-3-1-Docker服务状态检查"><a href="#3-3-1-Docker服务状态检查" class="headerlink" title="3.3.1 Docker服务状态检查"></a>3.3.1 Docker服务状态检查</h4><p><strong>检查目的</strong>：确认Docker服务运行正常，获取版本信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">"## 🐳 Docker服务状态"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查Docker服务是否运行</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">command</span> -v docker &gt;/dev/null 2&gt;&amp;1; <span class="keyword">then</span></span><br><span class="line">    docker_status=$(systemctl is-active docker 2&gt;/dev/null)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> [ <span class="string">"<span class="variable">$docker_status</span>"</span> = <span class="string">"active"</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"Docker服务: ✅ 运行中"</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 获取Docker版本</span></span><br><span class="line">        docker_version=$(docker --version 2&gt;/dev/null | awk <span class="string">'&#123;print $3&#125;'</span> | sed <span class="string">'s/,//'</span>)</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"Docker版本: <span class="variable">$docker_version</span>"</span></span><br><span class="line"></span><br><span class="line">        add_docker_data <span class="string">"service_status"</span> <span class="string">"running"</span></span><br><span class="line">        add_docker_data <span class="string">"version"</span> <span class="string">"<span class="variable">$docker_version</span>"</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"Docker服务: ⚠️ 未运行 (状态: <span class="variable">$docker_status</span>)"</span></span><br><span class="line">        add_docker_data <span class="string">"service_status"</span> <span class="string">"<span class="variable">$docker_status</span>"</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"Docker: ❌ 未安装"</span></span><br><span class="line">    add_docker_data <span class="string">"service_status"</span> <span class="string">"not_installed"</span></span><br><span class="line">    <span class="built_in">return</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>

<h4 id="3-3-2-容器统计与状态"><a href="#3-3-2-容器统计与状态" class="headerlink" title="3.3.2 容器统计与状态"></a>3.3.2 容器统计与状态</h4><p><strong>检查目的</strong>：了解容器总数、运行状态、停止状态</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">"## 📦 容器状态概览"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 统计容器数量</span></span><br><span class="line">total_containers=$(docker ps -a -q 2&gt;/dev/null | wc -l)</span><br><span class="line">running_containers=$(docker ps -q 2&gt;/dev/null | wc -l)</span><br><span class="line">paused_containers=$(docker ps -q -f status=paused 2&gt;/dev/null | wc -l)</span><br><span class="line">stopped_containers=$((total_containers - running_containers - paused_containers))</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"- 总容器数: <span class="variable">$total_containers</span>"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"- 运行中: <span class="variable">$running_containers</span>"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"- 已暂停: <span class="variable">$paused_containers</span>"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"- 已停止: <span class="variable">$stopped_containers</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 判断整体状态</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">"<span class="variable">$stopped_containers</span>"</span> -gt 0 ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"- 状态: ⚠️ 有 <span class="variable">$stopped_containers</span> 个容器已停止"</span></span><br><span class="line">    overall_status=<span class="string">"warning"</span></span><br><span class="line"><span class="keyword">elif</span> [ <span class="string">"<span class="variable">$running_containers</span>"</span> -gt 0 ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"- 状态: ✅ 正常"</span></span><br><span class="line">    overall_status=<span class="string">"ok"</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"- 状态: ⚠️ 无运行中的容器"</span></span><br><span class="line">    overall_status=<span class="string">"warning"</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 记录到JSON</span></span><br><span class="line">add_docker_data <span class="string">"containers_total"</span> <span class="string">"<span class="variable">$total_containers</span>"</span></span><br><span class="line">add_docker_data <span class="string">"containers_running"</span> <span class="string">"<span class="variable">$running_containers</span>"</span></span><br><span class="line">add_docker_data <span class="string">"containers_paused"</span> <span class="string">"<span class="variable">$paused_containers</span>"</span></span><br><span class="line">add_docker_data <span class="string">"containers_stopped"</span> <span class="string">"<span class="variable">$stopped_containers</span>"</span></span><br><span class="line">add_docker_data <span class="string">"overall_status"</span> <span class="string">"<span class="variable">$overall_status</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 列出停止的容器</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">"<span class="variable">$stopped_containers</span>"</span> -gt 0 ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">""</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"### 停止的容器："</span></span><br><span class="line">    docker ps -a -f status=exited --format <span class="string">"table &#123;&#123;.Names&#125;&#125;\t&#123;&#123;.Status&#125;&#125;\t&#123;&#123;.CreatedAt&#125;&#125;"</span> 2&gt;/dev/null</span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>

<p><strong>输出示例</strong>：</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">## 📦 容器状态概览</span></span><br><span class="line"><span class="bullet">- </span>总容器数: 25</span><br><span class="line"><span class="bullet">- </span>运行中: 23</span><br><span class="line"><span class="bullet">- </span>已暂停: 0</span><br><span class="line"><span class="bullet">- </span>已停止: 2</span><br><span class="line"><span class="bullet">- </span>状态: ⚠️ 有 2 个容器已停止</span><br><span class="line"></span><br><span class="line"><span class="section">### 停止的容器：</span></span><br><span class="line">NAMES           STATUS                    CREATEDAT</span><br><span class="line">old-postgres    Exited (0) 2 days ago     2026-01-16 10:30:00</span><br><span class="line">test-mysql      Exited (1) 5 days ago     2026-01-13 14:20:00</span><br></pre></td></tr></table></figure>

<h4 id="3-3-3-容器资源使用分析"><a href="#3-3-3-容器资源使用分析" class="headerlink" title="3.3.3 容器资源使用分析"></a>3.3.3 容器资源使用分析</h4><p><strong>检查目的</strong>：发现资源占用异常的容器，进行容量规划</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">"## 📊 容器资源使用（Top 10）"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"| 容器名 | 状态 | CPU% | 内存使用 | 内存% | 网络接收 | 网络发送 |"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"|--------|------|------|----------|--------|----------|----------|"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取容器实时资源使用（--no-stream避免持续输出）</span></span><br><span class="line">docker stats --no-stream --format <span class="string">"table &#123;&#123;.Name&#125;&#125;\t&#123;&#123;.CPUPerc&#125;&#125;\t&#123;&#123;.MemUsage&#125;&#125;\t&#123;&#123;.MemPerc&#125;&#125;\t&#123;&#123;.NetIO&#125;&#125;"</span> 2&gt;/dev/null | \</span><br><span class="line">    tail -n +2 | \</span><br><span class="line">    <span class="keyword">while</span> <span class="built_in">read</span> -r line; <span class="keyword">do</span></span><br><span class="line">        name=$(<span class="built_in">echo</span> <span class="string">"<span class="variable">$line</span>"</span> | awk <span class="string">'&#123;print $1&#125;'</span>)</span><br><span class="line">        cpu=$(<span class="built_in">echo</span> <span class="string">"<span class="variable">$line</span>"</span> | awk <span class="string">'&#123;print $2&#125;'</span> | sed <span class="string">'s/%//'</span>)</span><br><span class="line">        mem_usage=$(<span class="built_in">echo</span> <span class="string">"<span class="variable">$line</span>"</span> | awk <span class="string">'&#123;print $3&#125;'</span>)</span><br><span class="line">        mem_percent=$(<span class="built_in">echo</span> <span class="string">"<span class="variable">$line</span>"</span> | awk <span class="string">'&#123;print $4&#125;'</span> | sed <span class="string">'s/%//'</span>)</span><br><span class="line">        net_rx=$(<span class="built_in">echo</span> <span class="string">"<span class="variable">$line</span>"</span> | awk <span class="string">'&#123;print $5&#125;'</span>)</span><br><span class="line">        net_tx=$(<span class="built_in">echo</span> <span class="string">"<span class="variable">$line</span>"</span> | awk <span class="string">'&#123;print $6&#125;'</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 判断容器状态</span></span><br><span class="line">        <span class="keyword">if</span> docker ps --format <span class="string">"&#123;&#123;.Names&#125;&#125;"</span> | grep -q <span class="string">"^<span class="variable">$&#123;name&#125;</span>$"</span>; <span class="keyword">then</span></span><br><span class="line">            status=<span class="string">"✅"</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            status=<span class="string">"❌"</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 标记高资源占用</span></span><br><span class="line">        <span class="keyword">if</span> (( $(<span class="built_in">echo</span> <span class="string">"<span class="variable">$cpu</span> &gt; 50"</span> | bc -l 2&gt;/dev/null || <span class="built_in">echo</span> <span class="string">"0"</span>) )); <span class="keyword">then</span></span><br><span class="line">            cpu=<span class="string">"**<span class="variable">$cpu</span>%**"</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            cpu=<span class="string">"<span class="variable">$&#123;cpu&#125;</span>%"</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> [ <span class="string">"<span class="variable">$mem_percent</span>"</span> -gt 80 ] 2&gt;/dev/null; <span class="keyword">then</span></span><br><span class="line">            mem_usage=<span class="string">"**<span class="variable">$mem_usage</span>**"</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"| <span class="variable">$name</span> | <span class="variable">$status</span> | <span class="variable">$cpu</span> | <span class="variable">$mem_usage</span> | <span class="variable">$&#123;mem_percent&#125;</span>% | <span class="variable">$net_rx</span> | <span class="variable">$net_tx</span> |"</span></span><br><span class="line">    <span class="keyword">done</span> | head -n 11  <span class="comment"># 限制Top 10</span></span><br></pre></td></tr></table></figure>

<p><strong>关键点</strong>：</p>
<ul>
<li>使用<code>--no-stream</code>参数获取当前瞬时数据，而非持续输出</li>
<li>标记CPU&gt;50%和内存&gt;80%的容器，便于快速发现问题</li>
<li>区分运行中和停止的容器</li>
<li>限制输出数量，避免报告过长</li>
</ul>
<h4 id="3-3-4-镜像管理检查"><a href="#3-3-4-镜像管理检查" class="headerlink" title="3.3.4 镜像管理检查"></a>3.3.4 镜像管理检查</h4><p><strong>检查目的</strong>：发现悬空镜像，提供清理建议</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">"## 🖼️ 镜像管理"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 统计镜像数量</span></span><br><span class="line">total_images=$(docker images -q 2&gt;/dev/null | wc -l)</span><br><span class="line">dangling_images=$(docker images -f <span class="string">"dangling=true"</span> -q 2&gt;/dev/null | wc -l)</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"- 总镜像数: <span class="variable">$total_images</span>"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"- 悬空镜像数: <span class="variable">$dangling_images</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 列出镜像占用空间</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">"<span class="variable">$total_images</span>"</span> -gt 0 ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">""</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"### 镜像占用空间（Top 10）："</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"| 镜像名 | 标签 | 大小 | 创建时间 |"</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"|--------|------|------|----------|"</span></span><br><span class="line"></span><br><span class="line">    docker images --format <span class="string">"table &#123;&#123;.Repository&#125;&#125;\t&#123;&#123;.Tag&#125;&#125;\t&#123;&#123;.Size&#125;&#125;\t&#123;&#123;.CreatedAt&#125;&#125;"</span> 2&gt;/dev/null | \</span><br><span class="line">        tail -n +2 | \</span><br><span class="line">        head -n 10 | \</span><br><span class="line">        <span class="keyword">while</span> <span class="built_in">read</span> -r line; <span class="keyword">do</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">"| <span class="variable">$line</span> |"</span></span><br><span class="line">        <span class="keyword">done</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 清理建议</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">"<span class="variable">$dangling_images</span>"</span> -gt 0 ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">""</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"### 清理建议"</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"⚠️ 发现 <span class="variable">$dangling_images</span> 个悬空镜像，建议清理："</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"\`\`\`bash"</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"docker image prune -f"</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"\`\`\`"</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 计算可回收空间</span></span><br><span class="line">    dangling_size=$(docker images -f <span class="string">"dangling=true"</span> -q 2&gt;/dev/null | \</span><br><span class="line">        xargs docker inspect --format=<span class="string">'&#123;&#123;.Size&#125;&#125;'</span> 2&gt;/dev/null | \</span><br><span class="line">        awk <span class="string">'&#123;sum+=$1&#125; END &#123;printf "%.0f", sum/1024/1024&#125;'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"预计可回收空间: <span class="variable">$&#123;dangling_size&#125;</span>MB"</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>

<h4 id="3-3-5-存储空间使用"><a href="#3-3-5-存储空间使用" class="headerlink" title="3.3.5 存储空间使用"></a>3.3.5 存储空间使用</h4><p><strong>检查目的</strong>：了解Docker整体存储占用，发现异常占用</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">"## 💾 存储空间使用"</span></span><br><span class="line"></span><br><span class="line">docker_info=$(docker system df 2&gt;/dev/null)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ -n <span class="string">"<span class="variable">$docker_info</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"<span class="variable">$docker_info</span>"</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 解析存储使用数据</span></span><br><span class="line">    images_size=$(<span class="built_in">echo</span> <span class="string">"<span class="variable">$docker_info</span>"</span> | grep <span class="string">'Images'</span> | awk <span class="string">'&#123;print $3&#125;'</span>)</span><br><span class="line">    containers_size=$(<span class="built_in">echo</span> <span class="string">"<span class="variable">$docker_info</span>"</span> | grep <span class="string">'Containers'</span> | awk <span class="string">'&#123;print $3&#125;'</span>)</span><br><span class="line">    volumes_size=$(<span class="built_in">echo</span> <span class="string">"<span class="variable">$docker_info</span>"</span> | grep <span class="string">'Local Volumes'</span> | awk <span class="string">'&#123;print $3&#125;'</span>)</span><br><span class="line">    build_cache_size=$(<span class="built_in">echo</span> <span class="string">"<span class="variable">$docker_info</span>"</span> | grep <span class="string">'Build Cache'</span> | awk <span class="string">'&#123;print $3&#125;'</span>)</span><br><span class="line"></span><br><span class="line">    add_docker_data <span class="string">"storage_images"</span> <span class="string">"<span class="variable">$images_size</span>"</span></span><br><span class="line">    add_docker_data <span class="string">"storage_containers"</span> <span class="string">"<span class="variable">$containers_size</span>"</span></span><br><span class="line">    add_docker_data <span class="string">"storage_volumes"</span> <span class="string">"<span class="variable">$volumes_size</span>"</span></span><br><span class="line">    add_docker_data <span class="string">"storage_build_cache"</span> <span class="string">"<span class="variable">$build_cache_size</span>"</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 判断是否需要清理</span></span><br><span class="line">    <span class="keyword">if</span> [ <span class="string">"<span class="variable">$build_cache_size</span>"</span> != <span class="string">"0B"</span> ] &amp;&amp; [ <span class="string">"<span class="variable">$build_cache_size</span>"</span> != <span class="string">""</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">""</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"### 清理建议"</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"⚠️ 构建缓存占用 <span class="variable">$&#123;build_cache_size&#125;</span>，建议清理："</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"\`\`\`bash"</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"docker builder prune -f"</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"\`\`\`"</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"⚠️ 无法获取存储使用信息"</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>

<p><strong>输出示例</strong>：</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">## 💾 存储空间使用</span></span><br><span class="line">TYPE            TOTAL     ACTIVE    SIZE      RECLAIMABLE</span><br><span class="line">Images          15        10        3.2GB     1.1GB (34%)</span><br><span class="line">Containers      25        23        1.8GB     256MB (14%)</span><br><span class="line">Local Volumes   8         6         2.5GB     512MB (20%)</span><br><span class="line">Build Cache     0         0         856MB     856MB</span><br><span class="line"></span><br><span class="line"><span class="section">### 清理建议</span></span><br><span class="line">⚠️ 构建缓存占用 856MB，建议清理：</span><br><span class="line"><span class="code">```bash</span></span><br><span class="line"><span class="code">docker builder prune -f</span></span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">#### 3.3.6 网络和卷统计</span><br><span class="line"></span><br><span class="line">&#96;&#96;&#96;bash</span><br><span class="line">echo &quot;## 🔌 网络和卷&quot;</span><br><span class="line"></span><br><span class="line"># 统计网络</span><br><span class="line">total_networks&#x3D;$(docker network ls -q 2&gt;&#x2F;dev&#x2F;null | wc -l)</span><br><span class="line">echo &quot;- 网络总数: $total_networks&quot;</span><br><span class="line"></span><br><span class="line"># 列出网络</span><br><span class="line">if [ &quot;$total_networks&quot; -gt 0 ]; then</span><br><span class="line">    echo &quot;&quot;</span><br><span class="line">    echo &quot;### 网络列表：&quot;</span><br><span class="line">    docker network ls --format &quot;table &#123;&#123;.Name&#125;&#125;\t&#123;&#123;.Driver&#125;&#125;\t&#123;&#123;.Scope&#125;&#125;&quot; 2&gt;&#x2F;dev&#x2F;null</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"># 统计卷</span><br><span class="line">total_volumes&#x3D;$(docker volume ls -q 2&gt;&#x2F;dev&#x2F;null | wc -l)</span><br><span class="line">echo &quot;&quot;</span><br><span class="line">echo &quot;- 卷总数: $total_volumes&quot;</span><br><span class="line"></span><br><span class="line"># 列出卷</span><br><span class="line">if [ &quot;$total_volumes&quot; -gt 0 ]; then</span><br><span class="line">    echo &quot;&quot;</span><br><span class="line">    echo &quot;### 卷列表：&quot;</span><br><span class="line">    docker volume ls --format &quot;table &#123;&#123;.Name&#125;&#125;\t&#123;&#123;.Driver&#125;&#125;\t&#123;&#123;.Scope&#125;&#125;&quot; 2&gt;&#x2F;dev&#x2F;null</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">add_docker_data &quot;networks_total&quot; &quot;$total_networks&quot;</span><br><span class="line">add_docker_data &quot;volumes_total&quot; &quot;$total_volumes&quot;</span><br></pre></td></tr></table></figure>

<p><strong>关键点</strong>：</p>
<ul>
<li>提供清晰的清理建议和命令</li>
<li>统计并显示可回收空间，帮助决策是否清理</li>
<li>列出网络和卷，便于了解整体架构</li>
<li>所有数据同时记录到JSON，便于自动化分析</li>
</ul>
<h2 id="四、实际应用效果展示"><a href="#四、实际应用效果展示" class="headerlink" title="四、实际应用效果展示"></a>四、实际应用效果展示</h2><h3 id="4-1-基础健康检查报告"><a href="#4-1-基础健康检查报告" class="headerlink" title="4.1 基础健康检查报告"></a>4.1 基础健康检查报告</h3><h4 id="Markdown报告（人工阅读）"><a href="#Markdown报告（人工阅读）" class="headerlink" title="Markdown报告（人工阅读）"></a>Markdown报告（人工阅读）</h4><blockquote>
<p>图：健康检查报告</p>
</blockquote>
<p><img src="http://image2.ishareread.com/images/2026/20260121/health-check-192.168.0.55-20260118-164043.png" alt="基础健康检查报告"></p>
<h4 id="JSON报告（机器处理）"><a href="#JSON报告（机器处理）" class="headerlink" title="JSON报告（机器处理）"></a>JSON报告（机器处理）</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"summary"</span>: &#123;</span><br><span class="line">    <span class="attr">"host"</span>: &#123;</span><br><span class="line">      <span class="attr">"hostname"</span>: <span class="string">"pve-ubuntu-pandawiki"</span>,</span><br><span class="line">      <span class="attr">"ip"</span>: <span class="string">"192.168.0.55"</span>,</span><br><span class="line">      <span class="attr">"check_time"</span>: <span class="string">"2026-01-18T08:40:43+0000"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"overall_status"</span>: <span class="string">"warning"</span>,</span><br><span class="line">    <span class="attr">"status_counts"</span>: &#123;</span><br><span class="line">      <span class="attr">"ok"</span>: <span class="number">8</span>,</span><br><span class="line">      <span class="attr">"warning"</span>: <span class="number">3</span>,</span><br><span class="line">      <span class="attr">"critical"</span>: <span class="number">0</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"check_types"</span>: [<span class="string">"health"</span>]</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"details"</span>: &#123;</span><br><span class="line">    <span class="attr">"system"</span>: &#123;</span><br><span class="line">      <span class="attr">"uptime"</span>: <span class="string">"15 days, 3:24"</span>,</span><br><span class="line">      <span class="attr">"load_1min"</span>: <span class="number">0.15</span>,</span><br><span class="line">      <span class="attr">"load_5min"</span>: <span class="number">0.30</span>,</span><br><span class="line">      <span class="attr">"load_15min"</span>: <span class="number">0.35</span>,</span><br><span class="line">      <span class="attr">"network_total_connections"</span>: <span class="number">45</span>,</span><br><span class="line">      <span class="attr">"network_external_connections"</span>: <span class="number">8</span>,</span><br><span class="line">      <span class="attr">"network_listening_ports"</span>: <span class="number">12</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"memory"</span>: &#123;</span><br><span class="line">      <span class="attr">"total_mb"</span>: <span class="number">16384</span>,</span><br><span class="line">      <span class="attr">"used_mb"</span>: <span class="number">12500</span>,</span><br><span class="line">      <span class="attr">"available_mb"</span>: <span class="number">3884</span>,</span><br><span class="line">      <span class="attr">"used_percent"</span>: <span class="number">76.3</span>,</span><br><span class="line">      <span class="attr">"swap_total_mb"</span>: <span class="number">2048</span>,</span><br><span class="line">      <span class="attr">"swap_used_mb"</span>: <span class="number">256</span>,</span><br><span class="line">      <span class="attr">"swap_percent"</span>: <span class="number">12.5</span>,</span><br><span class="line">      <span class="attr">"status"</span>: <span class="string">"warning"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"disk"</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"mount"</span>: <span class="string">"/"</span>,</span><br><span class="line">        <span class="attr">"device"</span>: <span class="string">"/dev/sda1"</span>,</span><br><span class="line">        <span class="attr">"total_gb"</span>: <span class="string">"100G"</span>,</span><br><span class="line">        <span class="attr">"used_gb"</span>: <span class="string">"45G"</span>,</span><br><span class="line">        <span class="attr">"available_gb"</span>: <span class="string">"55G"</span>,</span><br><span class="line">        <span class="attr">"used_percent"</span>: <span class="number">45.0</span>,</span><br><span class="line">        <span class="attr">"status"</span>: <span class="string">"ok"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"mount"</span>: <span class="string">"/data"</span>,</span><br><span class="line">        <span class="attr">"device"</span>: <span class="string">"/dev/sdb1"</span>,</span><br><span class="line">        <span class="attr">"total_gb"</span>: <span class="string">"500G"</span>,</span><br><span class="line">        <span class="attr">"used_gb"</span>: <span class="string">"425G"</span>,</span><br><span class="line">        <span class="attr">"available_gb"</span>: <span class="string">"75G"</span>,</span><br><span class="line">        <span class="attr">"used_percent"</span>: <span class="number">85.0</span>,</span><br><span class="line">        <span class="attr">"status"</span>: <span class="string">"warning"</span></span><br><span class="line">      &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"services"</span>: &#123;</span><br><span class="line">      <span class="attr">"systemd_running"</span>: <span class="number">23</span>,</span><br><span class="line">      <span class="attr">"systemd_failed"</span>: <span class="number">0</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"security"</span>: &#123;</span><br><span class="line">      <span class="attr">"mining_detected"</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">"tmp_executables"</span>: <span class="number">0</span>,</span><br><span class="line">      <span class="attr">"failed_logins"</span>: <span class="number">3</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"metadata"</span>: &#123;</span><br><span class="line">    <span class="attr">"check_version"</span>: <span class="string">"1.0"</span>,</span><br><span class="line">    <span class="attr">"tool_version"</span>: <span class="string">"ops-health-check v1.0"</span>,</span><br><span class="line">    <span class="attr">"check_script"</span>: <span class="string">"health-check.sh"</span>,</span><br><span class="line">    <span class="attr">"thresholds"</span>: &#123;</span><br><span class="line">      <span class="attr">"disk_warning"</span>: <span class="number">50</span>,</span><br><span class="line">      <span class="attr">"disk_critical"</span>: <span class="number">80</span>,</span><br><span class="line">      <span class="attr">"memory_warning"</span>: <span class="number">70</span>,</span><br><span class="line">      <span class="attr">"memory_critical"</span>: <span class="number">90</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>实际价值</strong>：</p>
<ul>
<li>Markdown报告便于运维人员快速了解系统状态</li>
<li>JSON数据可被监控系统自动采集和分析</li>
<li>清晰的emoji状态指示，一眼就能看出问题所在</li>
<li>详细的阈值配置，便于追溯和调整</li>
</ul>
<h2 id="五、总结与展望"><a href="#五、总结与展望" class="headerlink" title="五、总结与展望"></a>五、总结与展望</h2><h3 id="5-1-实现成果"><a href="#5-1-实现成果" class="headerlink" title="5.1 实现成果"></a>5.1 实现成果</h3><p>本次开发成功构建了一个生产级运维健康检查系统：</p>
<p>✅ <strong>三大核心模块</strong></p>
<ul>
<li>基础健康检查：涵盖系统资源、服务状态、基础安全</li>
<li>深度安全检查：5大类20+项安全检查</li>
<li>Docker监控：容器、镜像、存储全方位监控</li>
</ul>
<p>✅ <strong>双格式输出</strong></p>
<ul>
<li>Markdown：人工可读，便于快速决策</li>
<li>JSON：机器可处理，易于自动化集成</li>
</ul>
<p>✅ <strong>广泛兼容性</strong></p>
<ul>
<li>bash 3.2+兼容（macOS默认版本）</li>
<li>支持主流Linux发行版（Ubuntu、CentOS、Debian）</li>
<li>适配systemd和SysV init系统</li>
</ul>
<p>✅ <strong>完整文档</strong></p>
<ul>
<li>SKILL.md：使用指南</li>
<li>设计文档：架构和实现思路</li>
<li>博客文章：实战经验分享</li>
</ul>
<h3 id="5-2-技术亮点"><a href="#5-2-技术亮点" class="headerlink" title="5.2 技术亮点"></a>5.2 技术亮点</h3><ol>
<li><strong>模块化设计</strong>：三个检查模块独立运行，互不依赖</li>
<li><strong>统一输出库</strong>：封装数据收集和格式化逻辑</li>
<li><strong>阈值可配置</strong>：支持通过环境变量自定义阈值</li>
<li><strong>兼容性处理</strong>：优雅降级，兼容不同版本工具</li>
<li><strong>清理建议</strong>：不仅发现问题，还提供解决建议</li>
</ol>
<h3 id="5-3-实际应用价值"><a href="#5-3-实际应用价值" class="headerlink" title="5.3 实际应用价值"></a>5.3 实际应用价值</h3><p><strong>效率提升</strong>：</p>
<ul>
<li>批量检查10台主机仅需2分钟</li>
<li>自动生成双格式报告，无需手工整理</li>
<li>JSON数据可直接导入监控系统</li>
</ul>
<p><strong>安全增强</strong>：</p>
<ul>
<li>发现并阻止挖矿程序</li>
<li>检测异常登录和未授权访问</li>
<li>及时发现文件系统异常变更</li>
</ul>
<p><strong>成本节约</strong>：</p>
<ul>
<li>无需部署复杂监控系统</li>
<li>基于现有SSH连接，无需额外代理</li>
<li>轻量级脚本，资源占用极低</li>
</ul>
<h3 id="5-4-开发体会"><a href="#5-4-开发体会" class="headerlink" title="5.4 开发体会"></a>5.4 开发体会</h3><p>通过Claude Code的AI辅助开发，整个过程非常高效：</p>
<ol>
<li><strong>快速迭代</strong>：从需求到实现不到4小时</li>
<li><strong>智能提示</strong>：Claude主动发现兼容性问题并给出解决方案</li>
<li><strong>代码质量</strong>：生成的代码结构清晰，符合最佳实践</li>
<li><strong>文档完善</strong>：自动生成详细的使用文档和示例</li>
</ol>
<p>AI辅助开发不仅提高了效率，更重要的是让开发者可以专注于业务逻辑和架构设计，而将具体的编码工作交给AI完成。这种人机协作模式，是未来软件开发的重要趋势。</p>
<p><strong>项目地址</strong>：<a href="https://github.com/xiejava/ops-health-check" target="_blank" rel="noopener">https://github.com/xiejava/ops-health-check</a></p>
<p><strong>博客地址</strong>：<a href="http://xiejava.ishareread.com">http://xiejava.ishareread.com</a></p>
<hr>
<p>🤖 <strong>本文由Claude Code辅助编写</strong></p>
<center> 

<br>

<p><img src="http://image2.ishareread.com/images/fullbug%E5%BE%AE%E4%BF%A1%E5%85%AC%E4%BC%97%E5%8F%B7.jpg" alt="“fullbug”微信公众号" title="“fullbug”微信公众号"> </p>
<p>关注：微信公众号,一起学习成长！</center></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://xiejava.ishareread.com/posts/db0ebabe/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="XieJava">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://img9.doubanio.com/icon/ul70489051-4.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="XieJava's blog">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/posts/db0ebabe/" itemprop="url">为了管好IP我上了一套开源的IP管理系统phpIPAM</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2025-12-19T14:33:19+08:00">
                2025-12-19
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">更新于&#58;</span>
              
              <time title="更新于" itemprop="dateModified" datetime="2025-12-19T17:16:13+08:00">
                2025-12-19
              </time>
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index">
                    <span itemprop="name">技术</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%8A%80%E6%9C%AF/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index">
                    <span itemprop="name">运维</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/posts/db0ebabe/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/posts/db0ebabe/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/posts/db0ebabe/" class="leancloud_visitors" data-flag-title="为了管好IP我上了一套开源的IP管理系统phpIPAM">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  957
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  3
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>通常，网络或系统管理员会使用一个电子表格来记录IP地址的分配信息，然而，随着网络中的设备越来越多依赖于电子表格并不方便，十分容易出错，想管理好这些加入网络中的设备，就得有个更方便的工具。就我家里的网络而言，接入的设备就已经接近40个了，亟需找这么一个工具来记录和管理这些IP，目前找到的比较好用又轻量化的IP管理工具就是phpIPAM。</p>
<h1 id="一、什么是phpIPAM"><a href="#一、什么是phpIPAM" class="headerlink" title="一、什么是phpIPAM"></a>一、什么是phpIPAM</h1><p>phpIPAM（PHP IP Address Manager）是一个开源的网络 IP 地址管理工具，其目标是提供轻松，现代和有用的IP地址管理。它是基于php的应用程序，带有MySQL数据库后端，使用jQuery库，ajax和HTML5 / CSS3功能。主要用于企业级 IP 地址空间的规划、管理和跟踪。</p>
<p><strong>为什么要用phpIPAM</strong></p>
<table>
<thead>
<tr>
<th>问题场景</th>
<th>无 phpIPAM</th>
<th>有 phpIPAM</th>
</tr>
</thead>
<tbody><tr>
<td>IP分配冲突</td>
<td>人工记录 Excel，容易重复</td>
<td>系统自动管理，避免冲突</td>
</tr>
<tr>
<td>查找可用 IP</td>
<td>手动测试多个 IP</td>
<td>一键查找空闲 IP</td>
</tr>
<tr>
<td>网络规划</td>
<td>凭经验划分，不精确</td>
<td>可视化规划，最优利用</td>
</tr>
<tr>
<td>故障排查</td>
<td>不知道 IP 使用者</td>
<td>快速定位设备负责人</td>
</tr>
</tbody></table>
<p><strong>phpIPAM核心功能如下：</strong><br><img src="http://image2.ishareread.com/images/2025/20251219/1-phpIPAM%E5%8A%9F%E8%83%BD.png" alt="\[图片\]"></p>
<p>官网：<br><a href="https://www.phpipam.net/" target="_blank" rel="noopener">https://www.phpipam.net/</a><br><a href="https://hub.docker.com/r/phpipam/phpipam-www/" target="_blank" rel="noopener">https://hub.docker.com/r/phpipam/phpipam-www/</a></p>
<h1 id="二、安装phpIPAM"><a href="#二、安装phpIPAM" class="headerlink" title="二、安装phpIPAM"></a>二、安装phpIPAM</h1><p>安装phpIPAM可以用docker方式快速安装，根据官网的docker-compose.yml稍微做了优化，主要是加了mysql的健康检查，因为在安装的过程中数据库没有就绪或容器启动顺序有问题会导致安装失败。<br>docker-compose.yml文件内容如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">version: <span class="string">'3.8'</span></span><br><span class="line">services:</span><br><span class="line">  phpipam-web:</span><br><span class="line">    image: phpipam/phpipam-www:latest</span><br><span class="line">    ports:</span><br><span class="line">      - <span class="string">"8488:80"</span></span><br><span class="line">    environment:</span><br><span class="line">      - TZ=Asia/Shanghai</span><br><span class="line">      - IPAM_DATABASE_HOST=phpipam-db</span><br><span class="line">      - IPAM_DATABASE_PASS=12345678</span><br><span class="line">    depends_on:</span><br><span class="line">      - phpipam-db</span><br><span class="line">    restart: unless-stopped</span><br><span class="line"></span><br><span class="line">  phpipam-cron:</span><br><span class="line">    image: phpipam/phpipam-cron:latest</span><br><span class="line">    environment:</span><br><span class="line">      - TZ=Asia/Shanghai</span><br><span class="line">      - IPAM_DATABASE_HOST=phpipam-db</span><br><span class="line">      - IPAM_DATABASE_PASS=12345678</span><br><span class="line">      - SCAN_INTERVAL=1h</span><br><span class="line">    depends_on:</span><br><span class="line">      phpipam-db:</span><br><span class="line">        condition: service_healthy</span><br><span class="line">    restart: unless-stopped</span><br><span class="line"></span><br><span class="line">  phpipam-db:</span><br><span class="line">    image: mariadb:10.5</span><br><span class="line">    environment:</span><br><span class="line">      - MYSQL_ROOT_PASSWORD=12345678</span><br><span class="line">      - MYSQL_DATABASE=phpipam</span><br><span class="line">      - MYSQL_USER=phpipam</span><br><span class="line">      - MYSQL_PASSWORD=12345678</span><br><span class="line">    volumes:</span><br><span class="line">      - db_data:/var/lib/mysql</span><br><span class="line">    restart: unless-stopped</span><br><span class="line">    healthcheck:</span><br><span class="line">      <span class="built_in">test</span>: [<span class="string">"CMD"</span>, <span class="string">"mysqladmin"</span>, <span class="string">"ping"</span>, <span class="string">"-h"</span>, <span class="string">"localhost"</span>]</span><br><span class="line">      interval: 10s</span><br><span class="line">      timeout: 5s</span><br><span class="line">      retries: 5</span><br><span class="line"></span><br><span class="line">volumes:</span><br><span class="line">  db_data:</span><br></pre></td></tr></table></figure>

<p>将docker-compose.yml文件考到安装目录如/home/app/phpipam<br>执行<code>docker compose up -d</code> 就可以顺利安装完成<br>安装完成后通过 <code>docker compose ps</code> 查看 phpipam的几个容器是否都正常启动了。<br><img src="http://image2.ishareread.com/images/2025/20251219/2-docker-compose-ps.png" alt="docker-compose"></p>
<p>可以通过<code>docker compose logs</code>查看日志</p>
<h1 id="三、初始化phpIPAM"><a href="#三、初始化phpIPAM" class="headerlink" title="三、初始化phpIPAM"></a>三、初始化phpIPAM</h1><p>因为在docker-compose.yml文件中映射的宿主机的端口是8488<br>在浏览器中输入 http://服务器IP：8488/<br>1.选择新的phpipam安装<br><img src="http://image2.ishareread.com/images/2025/20251219/3-%E6%96%B0%E7%9A%84phpipam%E5%AE%89%E8%A3%85.png" alt="新的phpipam安装"></p>
<p>2.安装pfpipam数据库<br><img src="http://image2.ishareread.com/images/2025/20251219/4-%E8%87%AA%E5%8A%A8%E5%AE%89%E8%A3%85%E6%95%B0%E6%8D%AE%E5%BA%93.png" alt="安装pfpipam数据库"></p>
<p>3.设置数据库<br><img src="http://image2.ishareread.com/images/2025/20251219/5-root%E6%95%B0%E6%8D%AE%E5%BA%93%E8%B4%A6%E5%8F%B7%E5%AF%86%E7%A0%81.png" alt="设置数据库"></p>
<p>4.提示数据库安装成功<br><img src="http://image2.ishareread.com/images/2025/20251219/6-%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%89%E8%A3%85%E6%88%90%E5%8A%9F.png" alt="数据库安装成功"></p>
<p>5.设置管理员密码<br><img src="http://image2.ishareread.com/images/2025/20251219/7-%E8%AE%BE%E7%BD%AEAdmin%E5%AF%86%E7%A0%81.png" alt="设置管理员密码"></p>
<p>6.用前面设置的管理员密码进行登录<br><img src="http://image2.ishareread.com/images/2025/20251219/8-%E7%94%A8%E6%88%B7%E5%90%8D%E5%AF%86%E7%A0%81%E7%99%BB%E5%BD%95.png" alt="用户名密码登录"></p>
<p>7.可以在用户的账户详情中选择语言为“Chinese(zh_CN.UTF-8)”切换成中文<br><img src="http://image2.ishareread.com/images/2025/20251219/9-%E5%88%87%E6%8D%A2%E6%88%90%E4%B8%AD%E6%96%87.png" alt="设置成中文"></p>
<h1 id="四、使用phpIPAM"><a href="#四、使用phpIPAM" class="headerlink" title="四、使用phpIPAM"></a>四、使用phpIPAM</h1><p>典型的IP管理流程如下：<br><img src="http://image2.ishareread.com/images/2025/20251219/10-phpIPAM%E7%AE%A1%E7%90%86%E6%B5%81%E7%A8%8B.png" alt="IP管理流程"></p>
<p>1.添加子网<img src="http://image2.ishareread.com/images/2025/20251219/11-%E6%B7%BB%E5%8A%A0%E5%AD%90%E7%BD%91.png" alt="添加子网"></p>
<p>2.添加子网信息，注意可以将Check hosts status、Discover new hosts、Resolve DNS name都打开。<br><img src="http://image2.ishareread.com/images/2025/20251219/12-%E7%BC%96%E8%BE%91%E5%AD%90%E7%BD%91.png" alt="添加子网信息"></p>
<p>3.在子网管理界面点击“Scan subnet for new hosts” 扫描子网的主机<br><img src="http://image2.ishareread.com/images/2025/20251219/13-%E7%82%B9%E5%87%BB%E6%89%AB%E6%8F%8F%E5%AD%90%E7%BD%91%E7%9A%84%E4%B8%BB%E6%9C%BA.png" alt="扫描子网"></p>
<p>4.点击“Scan subnet”<br>phpIPAM就会通过Ping scan的方式探测子网内存活的主机<br><img src="http://image2.ishareread.com/images/2025/20251219/14-%E5%AD%90%E7%BD%91%E6%89%AB%E6%8F%8F.png" alt="扫描子网"></p>
<p>在子网的管理界面就可以看到子网内存活的IP和空闲的IP<br><img src="http://image2.ishareread.com/images/2025/20251219/15-phpipam%E7%AE%A1%E7%90%86%E7%95%8C%E9%9D%A2.png" alt="子网管理界面"></p>
<p>IP列表<br><img src="http://image2.ishareread.com/images/2025/20251219/16-IP%E5%88%97%E8%A1%A8.png" alt="IP列表"></p>
<p>子网的可视化界面，可以很直观的看到子网内在用的IP和空闲的IP<br><img src="http://image2.ishareread.com/images/2025/20251219/17-%E5%AD%90%E7%BD%91%E5%8F%AF%E8%A7%86%E5%8C%96%E6%98%BE%E7%A4%BA.png" alt="子网可视化界面"></p>
<p>总的来说，phpIPAM安装简单使用方便，是个不错的IP管理工具。phpIPAM 本质上是一个 “网络的 CMDB”，让无形的 IP 地址变得可视、可控、可管理。对于任何有一定规模网络环境，它都是提升管理效率和规范性的重要工具。</p>
<hr>
<p>作者博客：<a href="http://xiejava.ishareread.com/">http://xiejava.ishareread.com/</a></p>
<center> 

<br>

<p><img src="http://image2.ishareread.com/images/fullbug%E5%BE%AE%E4%BF%A1%E5%85%AC%E4%BC%97%E5%8F%B7.jpg" alt="“fullbug”微信公众号" title="“fullbug”微信公众号"> </p>
<p>关注：微信公众号,一起学习成长！</center></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://xiejava.ishareread.com/posts/91eaa3b2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="XieJava">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://img9.doubanio.com/icon/ul70489051-4.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="XieJava's blog">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/posts/91eaa3b2/" itemprop="url">5分钟，我搭了一套AI知识库</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2025-12-09T20:00:42+08:00">
                2025-12-09
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">更新于&#58;</span>
              
              <time title="更新于" itemprop="dateModified" datetime="2025-12-17T19:21:52+08:00">
                2025-12-17
              </time>
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index">
                    <span itemprop="name">技术</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%8A%80%E6%9C%AF/AI/" itemprop="url" rel="index">
                    <span itemprop="name">AI</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/posts/91eaa3b2/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/posts/91eaa3b2/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/posts/91eaa3b2/" class="leancloud_visitors" data-flag-title="5分钟，我搭了一套AI知识库">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  2.1k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  7
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>一直以来都想把我的文档都集中起来建一套知识库，方便统一的搜索查询和调用。我用过很多的文档编写管理工具有在线的、离线的，包括有有道云笔记、语雀、飞书、Notion、Obsidian等。这些工具编写管理文档还可以但是要做为一个知识库还远远不够。我认为知识库不但要解决“知识存哪里” 的问题，更要解决 “知识怎么用” 的痛点，能够将多源的知识内容进行聚合，方便检索查询和使用。</p>
<p>我需要的知识库系统能够具备以下能力：</p>
<ul>
<li>多源内容聚合的能力：能够将我的博客网站、飞书、语雀、离线的文档等都能导入到知识库中。</li>
<li>方便快捷的搜索能力：AI辅助搜索，能够随时快速找到我想要的东西，AI辅助问答，能够基于已有的知识快速给出比较靠谱的答案。</li>
<li>便捷强大的编辑能力：能够通过富文本、Markdown随时记录文本，通过AI来辅助创作。</li>
</ul>
<p>几番比较找到了PandaWiki，这款开源AI大模型驱动的知识库搭建系统，我觉得满足了目前我对知识库的要求，其安装方便、使用便捷、免费开源，零成本就能拥有自己的AI知识库，目前在github上斩获了8.4K的Star说明了受欢迎的程度。</p>
<h1 id="一、什么是PandaWiki"><a href="#一、什么是PandaWiki" class="headerlink" title="一、什么是PandaWiki"></a>一、什么是PandaWiki</h1><p>PandaWiki 是一款 AI 大模型驱动的开源知识库搭建系统，帮助你快速构建智能化的 产品文档、技术文档、FAQ、博客系统，借助大模型的力量为你提供 AI 创作、AI 问答、AI 搜索等能力，具备富文本编辑、第三方集成和内容导入能力，采用AGPL-3.0开源协议。</p>
<p>它的核心价值在于将 AI 能力与知识库深度融合，不仅解决了 “知识存哪里” 的问题，更攻克了 “知识怎么用” 的痛点。<br><img src="http://image2.ishareread.com/images/2025/20251209/1-PandaWiki.png" alt="PandaWiki"><br>PandaWiki 的功能设计围绕 “智能化” 与 “便捷性” 展开，核心可概括为三大 AI 功能与五大实用特性，覆盖知识库从搭建到使用的全场景需求：</p>
<table>
<thead>
<tr>
<th>类别</th>
<th>具体功能</th>
<th>价值说明</th>
</tr>
</thead>
<tbody><tr>
<td>AI 核心功能</td>
<td>AI 创作</td>
<td>辅助生成、优化文档内容，降低内容生产门槛，提升写作效率</td>
</tr>
<tr>
<td></td>
<td>AI 问答</td>
<td>支持用户以自然语言提问，AI 基于知识库内容精准作答，而非返回杂乱链接</td>
</tr>
<tr>
<td></td>
<td>AI 搜索</td>
<td>依托 AI 大模型实现语义化搜索，精准匹配用户需求，解决传统关键词搜索的局限性</td>
</tr>
<tr>
<td>实用特性</td>
<td>富文本编辑</td>
<td>支持 Markdown 与 HTML 语法，满足不同用户编辑习惯；文档可导出为 Word、PDF、Markdown 格式</td>
</tr>
<tr>
<td></td>
<td>多渠道内容导入</td>
<td>支持通过飞书文档、Notion、URL、Sitemap、RSS 及离线文件导入内容，省去重复复制粘贴操作</td>
</tr>
<tr>
<td></td>
<td>第三方平台集成</td>
<td>可接入钉钉、飞书、企业微信、Discord 等平台的聊天机器人，实现 “随处查知识”</td>
</tr>
<tr>
<td></td>
<td>高度自定义</td>
<td>支持配置 Wiki 网站配色、背景图、水印、页脚（企业名称、ICP 备案、品牌 Logo 等），打造专属风格</td>
</tr>
<tr>
<td></td>
<td>数据统计与反馈</td>
<td>管理后台可实时查看 Wiki 网站的访问次数、用户分布、问答记录及反馈信息，便于优化内容</td>
</tr>
</tbody></table>
<p>PandaWiki 的最大优势之一是 “低门槛”—— 无需复杂代码开发，提供了一键部署安装脚本，全程耗时不超过 5 分钟，即使是非技术人员也能轻松上手。</p>
<h1 id="二、PandaWiki的安装部署"><a href="#二、PandaWiki的安装部署" class="headerlink" title="二、PandaWiki的安装部署"></a>二、PandaWiki的安装部署</h1><h2 id="1、部署前的准备"><a href="#1、部署前的准备" class="headerlink" title="1、部署前的准备"></a>1、部署前的准备</h2><p>PandaWiki的官方文档见 <a href="https://pandawiki.docs.baizhi.cloud/node/01971602-bb4e-7c90-99df-6d3c38cfd6d5" target="_blank" rel="noopener">https://pandawiki.docs.baizhi.cloud/node/01971602-bb4e-7c90-99df-6d3c38cfd6d5</a></p>
<p>PandaWiki安装需Linux系统、x86_64架构，依赖Docker 20.10.14+和Docker Compose 2.0.0+，推荐1核2G内存10G磁盘。<br>安装 PandaWiki 系统环境要求如下：</p>
<ul>
<li>操作系统：Linux</li>
<li>CPU 指令架构：x86_64、aarch64</li>
<li>软件依赖：Docker 20.10.14 版本以上</li>
<li>软件依赖：Docker Compose 2.0.0 版本以上</li>
<li>推荐配置：2 核 CPU / 4 GB 内存 / 20 GB 磁盘</li>
<li>最低配置：1 核 CPU / 2 GB 内存 / 5 GB 磁盘</li>
</ul>
<p>我的配置是ubuntu系统2核CPU/4GB内存/100GB磁盘。</p>
<h2 id="2、安装PandaWiki"><a href="#2、安装PandaWiki" class="headerlink" title="2、安装PandaWiki"></a>2、安装PandaWiki</h2><p>官方提供了一键自动安装命令，可以非常便捷无脑的就把系统给装上。<br>使用 root 权限登录你的服务器，然后执行以下命令。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash -c <span class="string">"<span class="variable">$(curl -fsSLk https://release.baizhi.cloud/panda-wiki/manager.sh)</span>"</span></span><br></pre></td></tr></table></figure>

<p><img src="http://image2.ishareread.com/images/2025/20251209/2-%E5%AE%89%E8%A3%85%E7%95%8C%E9%9D%A2.png" alt="安装界面"><br>选择“安装”，回车<br><img src="http://image2.ishareread.com/images/2025/20251209/3-%E5%AE%89%E8%A3%85docker.png" alt="安装"><br>系统检测到没有安装docker，输入“y”,系统自动安装docker<br><img src="http://image2.ishareread.com/images/2025/20251209/4-%E8%BE%93%E5%85%A5%E5%AE%89%E8%A3%85%E7%9B%AE%E5%BD%95.png" alt="自动安装docker"></p>
<p>默认安装路径位于 <code>/data/pandawiki</code><br>到显示所有容器安装完成并启动就会显示如下信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">SUCCESS  控制台信息:</span><br><span class="line">SUCCESS    访问地址(内网): https://*.*.*.*:2443</span><br><span class="line">SUCCESS    访问地址(外网): https://*.*.*.*:2443</span><br><span class="line">SUCCESS    用户名: admin</span><br><span class="line">SUCCESS    密码: **********************</span><br></pre></td></tr></table></figure>

<p>修改默认密码</p>
<blockquote>
<p>如果需要修改admin的密码可以修改安装目录下.env文件中的 ADMIN_PASSWORD 后，执行</p>
<p><code>bash docker compose up -d</code></p>
<p>即可生效。</p>
</blockquote>
<p>使用浏览器打开上述内容中的 “访问地址”，就可以看到 PandaWiki 的控制台登录入口。</p>
<p><img src="http://image2.ishareread.com/images/2025/20251209/5-PandaWiki%E7%99%BB%E5%BD%95%E7%95%8C%E9%9D%A2.png" alt="Panda登录地址"></p>
<h1 id="三、PandaWiki的使用"><a href="#三、PandaWiki的使用" class="headerlink" title="三、PandaWiki的使用"></a>三、PandaWiki的使用</h1><h2 id="1、配置-AI-大模型"><a href="#1、配置-AI-大模型" class="headerlink" title="1、配置 AI 大模型"></a>1、配置 AI 大模型</h2><p>由于 PandaWiki 的 AI 功能（创作、问答、搜索）均依赖 AI 大模型，首次使用需先完成模型配置，否则相关功能无法正常使用。其支持的模型类型及推荐方案如下：</p>
<ul>
<li>Chat 模型：用于对话与内容生成，如 ChatGPT-4、Deepseek-r1、Deepseek-v3 等</li>
<li>Embedding 模型：将文档转化为向量，支撑智能搜索与内容关联，如 BGE-M3</li>
<li>Reranker 模型：对搜索结果二次排序，提升检索精准度，如 BGE-Reranker-V2-M3</li>
</ul>
<p>我这里直接使用PandaWiki默认的模型“自动配置”。自动配置需要点击“获取百智云API Key”来获取API Key，注册登录百智云就可以获取5元的免费额度。当然通过手动配置用其他的模型API也可以。<br><img src="http://image2.ishareread.com/images/2025/20251209/6-%E9%85%8D%E7%BD%AE%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%95%8C%E9%9D%A2.png" alt="配置大模型"></p>
<h2 id="2、启用创建门户网站"><a href="#2、启用创建门户网站" class="headerlink" title="2、启用创建门户网站"></a>2、启用创建门户网站</h2><p>启用创建门户网站PandaWiki会自动帮创建一个门户网站，可以自定义门户网站的模板，“启用HTTP”输入暴露的端口80就可以开启门户网站，注意不要和2443端口重了，2443是后台admin的管理服务。<br><img src="http://image2.ishareread.com/images/2025/20251209/7-%E5%88%9B%E5%BB%BA%E9%97%A8%E6%88%B7%E7%BD%91%E7%AB%99.png" alt="创建门户网站"></p>
<p>通过简单的配置就可以生成一个wiki网站，如果有域名就可以通过域名访问了，没有域名就通过IP访问。<br>我这里配了域名，可以通过wiki.xiejava.dpdns.org访问。<br><img src="http://image2.ishareread.com/images/2025/20251209/8-%E8%AE%BF%E9%97%AE%E9%97%A8%E6%88%B7%E7%BD%91%E7%AB%99.png" alt="wiki门户网站"></p>
<h2 id="3、导入文档到PandaWiki创建知识库"><a href="#3、导入文档到PandaWiki创建知识库" class="headerlink" title="3、导入文档到PandaWiki创建知识库"></a>3、导入文档到PandaWiki创建知识库</h2><p>PandaWiki 支持从第三方文档中导入文档，目前支持以下几种方式</p>
<ul>
<li>通过离线文件导入</li>
<li>通过 URL 导入</li>
<li>通过 RSS 导入</li>
<li>通过 Sitemap 导入</li>
<li>通过 Notion 导入</li>
<li>通过 Epub 导入</li>
<li>通过 MiniDoc 导入</li>
<li>通过 Wiki.js 导入</li>
<li>通过 Confluence 导入</li>
<li>通过飞书文档导入</li>
<li>通过语雀导入</li>
<li>通过思源笔记导入</li>
</ul>
<p>官方都有详细的说明文档<br>我这里将我的博客文档通过离线方式进行导入。<br><img src="http://image2.ishareread.com/images/2025/20251209/9-%E9%80%89%E6%8B%A9%E5%AF%BC%E5%85%A5%E7%A6%BB%E7%BA%BF%E6%96%87%E4%BB%B6.png" alt="离线导入文件"></p>
<p>在离线文件导入界面选择要导入的文件，支持的格式包括<code>.txt、.md、.xlx、.xlsx、.docx、.pdf</code> 。<br>注意：每个文件的大小不能超过 20 MB。<br><img src="http://image2.ishareread.com/images/2025/20251209/10-%E5%AF%BC%E5%85%A5%E7%A6%BB%E7%BA%BF%E6%96%87%E4%BB%B6%E7%95%8C%E9%9D%A2.png" alt="导入文件"></p>
<p>选择要导入的文件后，会对.md文件自动进行解析。<br><img src="http://image2.ishareread.com/images/2025/20251209/11-%E5%AF%BC%E5%85%A5%E7%A6%BB%E7%BA%BF%E6%96%87%E4%BB%B6.png" alt="解析文件"></p>
<p>解析完了点击“批量导入”，就可以将文件导入到知识库，并且展示的是解析后的富文本形式。<br><img src="http://image2.ishareread.com/images/2025/20251209/12-%E6%89%B9%E9%87%8F%E5%AF%BC%E5%85%A5%E6%96%87%E4%BB%B6.png" alt="批量导入"></p>
<p>批量导入处理中<br><img src="http://image2.ishareread.com/images/2025/20251209/13-%E6%89%B9%E9%87%8F%E5%AF%BC%E5%85%A5%E4%B8%AD.png" alt="批量导入中"></p>
<p>新导入的文件虽然是可以被可见、被访问、被问答，但是还没有进行增强学习处理需要进一步的学习<br><img src="http://image2.ishareread.com/images/2025/20251209/14-%E5%AD%A6%E4%B9%A0%E6%96%87%E4%BB%B6.png" alt="发布和学习"></p>
<p>PandaWiki的文档处理状态如下图：<br><img src="http://image2.ishareread.com/images/2025/20251209/15-%E6%96%87%E6%A1%A3%E5%A4%84%E7%90%86%E7%8A%B6%E6%80%81.png" alt="文档处理状态"></p>
<p>选择需要学习的文档点“确认”进行学习<br><img src="http://image2.ishareread.com/images/2025/20251209/16-%E7%A1%AE%E8%AE%A4%E5%AD%A6%E4%B9%A0.png" alt="学习和发布"></p>
<p>当学习和发布完成后，可以在web门户网站进行AI检索和AI问答了。<br><img src="http://image2.ishareread.com/images/2025/20251209/17-%E5%90%91AI%E6%8F%90%E9%97%AE.png" alt="AI问答"></p>
<p><img src="http://image2.ishareread.com/images/2025/20251209/18-AI%E6%A3%80%E7%B4%A2%E7%9F%A5%E8%AF%86%E5%BA%93.png" alt="AI问答"></p>
<p>我们可以将pandawiki直接当一个博客网站来使用，它对markdown的解析和展示还挺好的。<br><img src="http://image2.ishareread.com/images/2025/20251209/19-AI-Wiki.png" alt="pandawiki博客站点"></p>
<p>欢迎访问我的wiki站点 <a href="https://wiki.xiejava.dpdns.org" target="_blank" rel="noopener">https://wiki.xiejava.dpdns.org</a> 在这里我将和你一起分享IT技术，感受AI带来的便捷。</p>
<hr>
<p>作者博客：<a href="http://xiejava.ishareread.com/">http://xiejava.ishareread.com/</a></p>
<center> 

<br>

<p><img src="http://image2.ishareread.com/images/fullbug%E5%BE%AE%E4%BF%A1%E5%85%AC%E4%BC%97%E5%8F%B7.jpg" alt="“fullbug”微信公众号" title="“fullbug”微信公众号"> </p>
<p>关注：微信公众号,一起学习成长！</center></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://xiejava.ishareread.com/posts/3ea90a75/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="XieJava">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://img9.doubanio.com/icon/ul70489051-4.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="XieJava's blog">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/posts/3ea90a75/" itemprop="url">企业级私有docker镜像仓库Harbor的搭建和使用</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2025-12-04T11:22:22+08:00">
                2025-12-04
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">更新于&#58;</span>
              
              <time title="更新于" itemprop="dateModified" datetime="2025-12-17T19:21:52+08:00">
                2025-12-17
              </time>
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index">
                    <span itemprop="name">技术</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%8A%80%E6%9C%AF/%E6%9E%B6%E6%9E%84/" itemprop="url" rel="index">
                    <span itemprop="name">架构</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/posts/3ea90a75/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/posts/3ea90a75/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/posts/3ea90a75/" class="leancloud_visitors" data-flag-title="企业级私有docker镜像仓库Harbor的搭建和使用">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  1.4k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  5
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="一、什么是Harbor"><a href="#一、什么是Harbor" class="headerlink" title="一、什么是Harbor"></a>一、什么是Harbor</h1><p>简单来说，Harbor 是一个开源的企业级私有 Docker 镜像仓库服务。我们可以把它理解成一个 “私有的、安全的、功能强大的 Docker Hub”。</p>
<ul>
<li>私有： 它部署在你自己的基础设施（如公司的数据中心或私有云）上，你完全掌控其中的所有镜像，不对外公开。</li>
<li>企业级： 这意味着它不仅仅是一个简单的存储服务器。它提供了企业所需的高级功能，如权限控制、安全扫描、镜像复制、图形化操作界面等。</li>
<li>镜像仓库： 它是专门用来存储、管理和分发 Docker 镜像的地方。你可以向 Harbor 中推送（上传）镜像，也可以从 Harbor 中拉取（下载）镜像。</li>
</ul>
<p>目前国内的上网环境公共的Docker Hub不能直接访问了，对于公司和个人开发者来说有必要搭建私有的Docker镜像仓库，使用 Harbor 几乎是必须的。公司自己开发的应用程序镜像可能包含敏感代码和配置，绝不能放到公共仓库。Harbor 提供了一个安全的私有环境来存放这些资产。Harbor 可以配置为 Docker Hub、Google Container Registry（GCR）等公有仓库的代理缓存。当公司内第一个开发者拉取某个公有镜像（如 nginx:latest）时，Harbor 会从公网下载并缓存到本地。后续所有开发者再拉取这个镜像时，都会直接从内网的 Harbor 服务器高速获取，极大地节省了公网带宽，加快了拉取速度。</p>
<p>Harbor 将一个简单的镜像存储服务，升级为一个安全、高效、可靠的企业级镜像生命周期管理平台，是现代云原生应用开发和运维不可或缺的基础设施组件。</p>
<p>本文介绍如何通过Harbor搭建和使用自己的私有镜像仓库。</p>
<h1 id="二、安装Harbor"><a href="#二、安装Harbor" class="headerlink" title="二、安装Harbor"></a>二、安装Harbor</h1><p>准备一台linux的服务器，我这里是ubuntu 24.04  IP地址是192.168.0.49<br>Harbor的docker安装要求<br>On a Linux host: docker 20.10.10-ce+ and docker-compose 1.18.0+ .</p>
<h2 id="1、安装docker"><a href="#1、安装docker" class="headerlink" title="1、安装docker"></a>1、安装docker</h2><p>执行以下命令一键安装docker </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo curl -fsSL https://get.docker.com | bash -s docker --mirror Aliyun</span><br><span class="line">service docker start</span><br></pre></td></tr></table></figure>

<p>配置国内镜像加速</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/docker/daemon.json</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">"registry-mirrors"</span>: [</span><br><span class="line">        <span class="string">"https://docker.1ms.run"</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service docker restart</span><br></pre></td></tr></table></figure>

<h2 id="2、安装Harbor"><a href="#2、安装Harbor" class="headerlink" title="2、安装Harbor"></a>2、安装Harbor</h2><p>下载harbor安装包，下载地址如下：<br><a href="https://github.com/goharbor/harbor/releases/download/v2.14.1/harbor-offline-installer-v2.14.1.tgz" target="_blank" rel="noopener">https://github.com/goharbor/harbor/releases/download/v2.14.1/harbor-offline-installer-v2.14.1.tgz</a><br>将下载的harbor安装包上传到安装harbor的目标服务器的目录下<br>如/home/app/harbor<br>解压上传的harbor安装包</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf harbor-offline-installer-v2.14.1.tgz</span><br></pre></td></tr></table></figure>

<p>备份配置文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp harbor.yml.tmpl harbor.yml</span><br></pre></td></tr></table></figure>

<p>修改配置文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim harbor.yml</span><br></pre></td></tr></table></figure>
<p><img src="http://image2.ishareread.com/images/2025/20251204/1-%E4%BF%AE%E6%94%B9harbor%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6.png" alt="修改harbor.yml配置文件"></p>
<p> 执行安装脚本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./install.sh</span><br></pre></td></tr></table></figure>

<p>安装完成后通过浏览器即可以访问harbor的管理界面<br><img src="http://image2.ishareread.com/images/2025/20251204/2-harbor%E7%99%BB%E5%BD%95%E7%95%8C%E9%9D%A2.png" alt="harbor登录界面"></p>
<p>默认的用户名和密码是<code>admin/Harbor12345</code></p>
<h1 id="三、使用Harbor"><a href="#三、使用Harbor" class="headerlink" title="三、使用Harbor"></a>三、使用Harbor</h1><h2 id="1、通过Harbor代理拉取镜像"><a href="#1、通过Harbor代理拉取镜像" class="headerlink" title="1、通过Harbor代理拉取镜像"></a>1、通过Harbor代理拉取镜像</h2><p>先在仓库管理中建一个目标，目标是从docker的加速镜像站点去拉取镜像，我这里配置目标URL是<code>https://docker.1ms.run</code>，点击测试链接，提示“测试连接成功”表示目标URL站点没有问题，就可以点击确定。<br><img src="http://image2.ishareread.com/images/2025/20251204/3-harbor%E6%96%B0%E5%BB%BA%E7%9B%AE%E6%A0%87.png" alt="新建目标"></p>
<p>这样我们就有了一个目标的加速仓库<br><img src="http://image2.ishareread.com/images/2025/20251204/4-%E6%88%90%E5%8A%9F%E5%88%9B%E5%BB%BA%E4%BB%93%E5%BA%93%E7%AE%A1%E7%90%86%E7%9B%AE%E6%A0%87.png" alt="新建目标成功"></p>
<p>在“项目”中点击“新建项目”，在镜像代理中<strong>开启</strong>“镜像代理”，选择我们开始在仓库管理中新建的目标仓库。<br><img src="http://image2.ishareread.com/images/2025/20251204/5-%E6%96%B0%E5%BB%BA%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%90%AF%E9%95%9C%E5%83%8F%E4%BB%A3%E7%90%86.png" alt="开启镜像代理"></p>
<p>在配置管理生成软件物料清单中勾选“在推送镜像时自动生成软件物料清单”，这样我们在拉取镜像时harbor会自动帮我们缓存镜像到本地的harbor仓库，下次拉取时速度就非常快了。<br><img src="http://image2.ishareread.com/images/2025/20251204/6-%E5%BC%80%E5%90%AF%E6%8E%A8%E9%80%81%E7%94%9F%E6%88%90%E7%89%A9%E6%96%99%E6%B8%85%E5%8D%95.png" alt="勾选物料清单"></p>
<p>在另外一台需要拉取镜像的机器上配置docker的镜像仓库，将地址配置为Harbor的地址</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/docker/daemon.json</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">"registry-mirrors"</span>: [</span><br><span class="line">        <span class="string">"http://192.168.0.49"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">"insecure-registries"</span>: [<span class="string">"192.168.0.49"</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>重启docker服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service docker restart</span><br></pre></td></tr></table></figure>

<p>拉取目标镜像，这里要带上harbor中的项目名称，<code>docker1ms/nginx:1.22</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull docker1ms/nginx:1.22</span><br></pre></td></tr></table></figure>

<p><img src="http://image2.ishareread.com/images/2025/20251204/7-docker%E6%8B%89%E5%8F%96%E9%95%9C%E5%83%8F.png" alt="拉取镜像"></p>
<p>在harbor的管理界面可以看到，通过拉取镜像，harbor通过代理镜像源对镜像进行了拉取并缓存到harbor仓库，下次拉取速度更快了。<br><img src="http://image2.ishareread.com/images/2025/20251204/8-harbor%E6%8B%89%E5%8F%96%E9%95%9C%E5%83%8F%E6%88%90%E5%8A%9F.png" alt="harbor镜像缓存"></p>
<h2 id="2、上传镜像到Harbor仓库"><a href="#2、上传镜像到Harbor仓库" class="headerlink" title="2、上传镜像到Harbor仓库"></a>2、上传镜像到Harbor仓库</h2><p>另一个在工作中最常用的场景就是将自己的镜像上传到镜像仓库，以便其他人拉取使用。<br>下面就以在本地已经存在的docker1ms/busybox:latest为例，上传到自己的harbor仓库。<br>我的harbor仓库的地址是192.168.0.49,上传到默认的library项目中<br>为镜像打上带仓库地址和项目名的tag</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker tag docker1ms/busybox:latest 192.168.0.49/library/busybox:latest</span><br></pre></td></tr></table></figure>

<p><img src="http://image2.ishareread.com/images/2025/20251204/9-%E7%BB%99%E9%95%9C%E5%83%8F%E6%89%93%E6%A0%87%E7%AD%BE.png" alt="为镜像打标签"></p>
<p>客户端登录到harbor</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker login 192.168.0.49</span><br></pre></td></tr></table></figure>

<p>输入harbor的用户名和口令进行登录<br><img src="http://image2.ishareread.com/images/2025/20251204/10-%E7%99%BB%E5%BD%95%E5%88%B0harbor.png" alt="登录到harbor仓"></p>
<p>登录成功后，通过push命令上传镜像到本地harbor仓库</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker push 192.168.0.49/library/busybox:latest</span><br></pre></td></tr></table></figure>

<p><img src="http://image2.ishareread.com/images/2025/20251204/11-push%E9%95%9C%E5%83%8F.png" alt="push镜像"></p>
<p>到harbor管理界面查看push到仓库中的镜像<br><img src="http://image2.ishareread.com/images/2025/20251204/12-%E6%9F%A5%E7%9C%8Bpush%E7%9A%84%E9%A1%B9%E7%9B%AE.png" alt="push到仓库中的镜像"></p>
<p>可以看到busybox镜像已经成功push到harbor的library项目中了。<br><img src="http://image2.ishareread.com/images/2025/20251204/13-%E6%9F%A5%E7%9C%8Bpush%E7%9A%84%E9%A1%B9%E7%9B%AE%E7%9A%84%E9%95%9C%E5%83%8F%E4%BB%93%E5%BA%93.png" alt="成功push"></p>
<p>在Artifacts中可以看到push上来的镜像物料详情，可看到这个busybox镜像的大小是2.1MB<br><img src="http://image2.ishareread.com/images/2025/20251204/14-%E6%9F%A5%E7%9C%8Bpush%E9%95%9C%E5%83%8F%E7%9A%84%E7%89%A9%E6%96%99.png" alt="物料清单"></p>
<p>我们可以直接拉取harbor中我们刚push上去的镜像<br>可以看到如果是默认仓库library项目直接可以docker pull 镜像名就可以拉取</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull busybox:latest</span><br></pre></td></tr></table></figure>

<p><img src="http://image2.ishareread.com/images/2025/20251204/15-%E7%9B%B4%E6%8E%A5%E6%8B%89%E5%8F%96harbor%E5%BA%93%E4%B8%AD%E7%9A%84%E9%95%9C%E5%83%8F.png" alt="拉取镜像"></p>
<p>至此，我们通过安装自己私有的镜像仓库Harbor，实现了docker镜像代理下载和上传自己的镜像到Harbor仓库，覆盖了我们平时工作中的大部分场景。</p>
<hr>
<p>作者博客：<a href="http://xiejava.ishareread.com/">http://xiejava.ishareread.com/</a></p>
<center> 

<br>

<p><img src="http://image2.ishareread.com/images/fullbug%E5%BE%AE%E4%BF%A1%E5%85%AC%E4%BC%97%E5%8F%B7.jpg" alt="“fullbug”微信公众号" title="“fullbug”微信公众号"> </p>
<p>关注：微信公众号,一起学习成长！</center></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://xiejava.ishareread.com/posts/52b3e2de/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="XieJava">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://img9.doubanio.com/icon/ul70489051-4.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="XieJava's blog">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/posts/52b3e2de/" itemprop="url">开源安全管理平台wazuh-检测SQL注入攻击</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2025-10-22T16:33:12+08:00">
                2025-10-22
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">更新于&#58;</span>
              
              <time title="更新于" itemprop="dateModified" datetime="2025-12-17T19:21:52+08:00">
                2025-12-17
              </time>
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index">
                    <span itemprop="name">技术</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%8A%80%E6%9C%AF/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/" itemprop="url" rel="index">
                    <span itemprop="name">网络安全</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/posts/52b3e2de/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/posts/52b3e2de/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/posts/52b3e2de/" class="leancloud_visitors" data-flag-title="开源安全管理平台wazuh-检测SQL注入攻击">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  742
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  3
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Wazuh是一个功能强大的开源安全平台，它集成了安全信息与事件管理（SIEM）和扩展检测与响应（XDR）的能力，旨在为本地、虚拟化、容器化及云环境中的工作负载提供统一的威胁预防、检测和响应解决方案。</p>
<p>SQL 注入是一种攻击，在这种攻击中，威胁行为者将恶意代码插入传输到数据库服务器的字符串中进行解析和执行。成功的 SQL 注入攻击可以未经授权访问数据库中包含的机密信息。</p>
<p>我们可以使用 Wazuh 从 Web 服务器日志中检测 SQL 注入攻击，这些日志包含 select、union 和其他常见 SQL 注入模式等模式。本文通过POC来验证wazuh检测SQL注入攻击。</p>
<h1 id="一、环境准备"><a href="#一、环境准备" class="headerlink" title="一、环境准备"></a>一、环境准备</h1><p>POC测试环境拓扑如下图所示：</p>
<p><img src="http://image2.ishareread.com/images/2025/20251022/1-POC%E6%B5%8B%E8%AF%95%E7%8E%AF%E5%A2%83%E6%8B%93%E6%89%91.png" alt="POC测试环境拓扑"></p>
<table>
<thead>
<tr>
<th>主机</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>安全管理平台wazuh-server<br>(192.168.0.40)</td>
<td>All in one安装wazuh，监控wazuh-agent上报的告警信息进行威胁检测</td>
</tr>
<tr>
<td>DVWA靶机<br>（192.168.0.43）</td>
<td>被监控主机安装wazuh-agent，安装DVWA靶机，模拟被攻击</td>
</tr>
</tbody></table>
<p>DVWA靶机安装参考《<a href="https://blog.csdn.net/fullbug/article/details/129879670" target="_blank" rel="noopener">CentOS7+LAMP+DVWA靶机搭建</a>》<br>首先安装LAMP环境</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">apt update</span><br><span class="line">apt install -y apache2 mariadb-server mariadb-client php php-mysqli php-gd libapache2-mod-php</span><br></pre></td></tr></table></figure>

<p>下载DVWA的软件包<br>进入到默认的web发布目录</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /var/www/html</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/digininja/DVWA.git</span><br></pre></td></tr></table></figure>

<p>将config/config.inc.php.dist复制成config/config.inc.php并配置环境</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp config.inc.php.dist config.inc.php</span><br></pre></td></tr></table></figure>

<p>用root用户登录数据库，然后执行以下命令创建dvwa数据库:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; create database dvwa;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; create user dvwa@localhost identified by <span class="string">'p@ssw0rd'</span>;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; grant all on dvwa.* to dvwa@localhost;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; flush privileges;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>默认用户 = <code>admin</code><br>默认密码 = <code>password</code><br>将安全级别设为 Low（最易注入）</p>
<h1 id="二、wazuh配置"><a href="#二、wazuh配置" class="headerlink" title="二、wazuh配置"></a>二、wazuh配置</h1><p>将以下行添加到 Wazuh 代理 <code>/var/ossec/etc/ossec.conf</code> 文件中。允许 Wazuh-agent 代理监控 Apache 服务器的访问日志：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;ossec_config&gt;</span><br><span class="line">  &lt;localfile&gt;</span><br><span class="line">    &lt;log_format&gt;apache&lt;/log_format&gt;</span><br><span class="line">    &lt;location&gt;/var/<span class="built_in">log</span>/apache2/access.log&lt;/location&gt;</span><br><span class="line">  &lt;/localfile&gt;</span><br><span class="line">&lt;/ossec_config&gt;</span><br></pre></td></tr></table></figure>

<p>重新启动 Wazuh 代理以使应用配置更改生效：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl restart wazuh-agent</span><br></pre></td></tr></table></figure>

<h1 id="三、模拟攻击"><a href="#三、模拟攻击" class="headerlink" title="三、模拟攻击"></a>三、模拟攻击</h1><p>访问DVWA的靶机地址<a href="http://192.168.0.43/DVWA/login.php" target="_blank" rel="noopener">http://192.168.0.43/DVWA/login.php</a><br>默认用户 = admin<br>默认密码 = password<br>登录后找到SQL Injection 输入例如”<code>1&#39; UNION SELECT database(), version()</code>“ 等SQL注入Payload</p>
<p><img src="http://image2.ishareread.com/images/2025/20251022/2-dvwaSQL%E6%B3%A8%E5%85%A5.png" alt="DVWA-SQL注入"></p>
<h1 id="四、效果验证"><a href="#四、效果验证" class="headerlink" title="四、效果验证"></a>四、效果验证</h1><p>在wazuh此处的预期结果是规则 ID 为 31164  <code>SQL injection attempt</code> 的告警，但成功的 SQL 注入尝试会生成规则 ID 为 31106  <code>A web attack returned code 200 (success)</code>的告警。</p>
<p><img src="http://image2.ishareread.com/images/2025/20251022/3-wazuhSQL%E6%B3%A8%E5%85%A5%E5%91%8A%E8%AD%A6.png" alt="sql注入检测"></p>
<p>我们可以点击详情看到具体的SQL注入攻击日志</p>
<p><img src="http://image2.ishareread.com/images/2025/20251022/4-wazuhSQL%E6%B3%A8%E5%85%A5%E5%91%8A%E8%AD%A6%E8%AF%A6%E6%83%85.png" alt="SQL注入检测日志详情"></p>
<p>至此，我们通过POC验证了wazuh检测SQL注入攻击场景。</p>
<hr>
<p>作者博客：<a href="http://xiejava.ishareread.com/">http://xiejava.ishareread.com/</a></p>
<center> 

<br>

<p><img src="http://image2.ishareread.com/images/fullbug%E5%BE%AE%E4%BF%A1%E5%85%AC%E4%BC%97%E5%8F%B7.jpg" alt="“fullbug”微信公众号" title="“fullbug”微信公众号"> </p>
<p>关注：微信公众号,一起学习成长！</center></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://xiejava.ishareread.com/posts/e0557478/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="XieJava">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://img9.doubanio.com/icon/ul70489051-4.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="XieJava's blog">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/posts/e0557478/" itemprop="url">开源安全管理平台wazuh-非法可疑进程检测</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2025-10-15T19:50:52+08:00">
                2025-10-15
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">更新于&#58;</span>
              
              <time title="更新于" itemprop="dateModified" datetime="2025-12-17T19:21:52+08:00">
                2025-12-17
              </time>
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index">
                    <span itemprop="name">技术</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%8A%80%E6%9C%AF/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/" itemprop="url" rel="index">
                    <span itemprop="name">网络安全</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/posts/e0557478/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/posts/e0557478/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/posts/e0557478/" class="leancloud_visitors" data-flag-title="开源安全管理平台wazuh-非法可疑进程检测">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  1.1k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  4
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Wazuh是一个功能强大的开源安全平台，它集成了安全信息与事件管理（SIEM）和扩展检测与响应（XDR）的能力，旨在为本地、虚拟化、容器化及云环境中的工作负载提供统一的威胁预防、检测和响应解决方案。</p>
<p>Wazuh命令监控功能在端点上运行命令并监控命令的输出。通过监控命令来检测是否有非法可疑进程。</p>
<p>本文通过POC展示Wazuh如何通过配置来实现对非法可疑进行的检测及时预警威胁攻击行为。</p>
<h1 id="一、环境准备"><a href="#一、环境准备" class="headerlink" title="一、环境准备"></a>一、环境准备</h1><p>POC测试环境拓扑如下图所示：<br><img src="http://image2.ishareread.com/images/2025/20251015/1-wazuh%E9%9D%9E%E6%B3%95%E5%8F%AF%E7%96%91%E8%BF%9B%E7%A8%8B%E6%A3%80%E6%B5%8B.png" alt="POC测试环境拓扑"></p>
<table>
<thead>
<tr>
<th>主机</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>安全管理平台wazuh-server<br>(192.168.0.40)</td>
<td>All in one安装wazuh，监控wazuh-agent上报的告警信息进行威胁检测</td>
</tr>
<tr>
<td>被监控Kali主机<br>（192.168.0.65）</td>
<td>被监控kali主机安装wazuh-agent，运行非法可疑进程。</td>
</tr>
</tbody></table>
<h1 id="二、wazuh配置"><a href="#二、wazuh配置" class="headerlink" title="二、wazuh配置"></a>二、wazuh配置</h1><h2 id="1、kali检测端点配置"><a href="#1、kali检测端点配置" class="headerlink" title="1、kali检测端点配置"></a>1、kali检测端点配置</h2><p>1）按照以下步骤配置命令监控并查询被监控kali主机端点上的所有运行进程。<br>将以下配置块添加到wazuh-agent的<code>/var/ossec/etc/ossec.conf</code>文件，允许wazuh-agent定期获取运行进程列表：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">ossec_config</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">localfile</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">log_format</span>&gt;</span>full_command<span class="tag">&lt;/<span class="name">log_format</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">alias</span>&gt;</span>process list<span class="tag">&lt;/<span class="name">alias</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">command</span>&gt;</span>ps -e -o pid,uname,command<span class="tag">&lt;/<span class="name">command</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">frequency</span>&gt;</span>30<span class="tag">&lt;/<span class="name">frequency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">localfile</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ossec_config</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>这段配置告诉 Wazuh 代理：</p>
<ol>
<li>做什么：​ 每 30 秒执行一次命令 <code>ps -e -o pid,uname,command</code>。</li>
<li>捕获什么：​ 捕获该命令的完整输出。</li>
<li>如何标记：​ 在输出的每一行前面添加一个标准化的头部 <code>ossec: output: &#39;process list: &#39;</code>。</li>
<li>发送给谁：​ 将处理后的日志行（即带有前缀的进程列表）发送给配置的 Wazuh 服务器。</li>
</ol>
<p>这个配置让 Wazuh 代理定期（每 30 秒）抓取一次完整的系统进程快照，并格式化后发送给服务器，为基于进程行为的入侵检测提供基础数据。</p>
<p>2）重新启动Wazuh代理以使配置生效：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl restart wazuh-agent</span><br></pre></td></tr></table></figure>

<p>3）在kali上安装Netcat等工具：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install ncat nmap -y</span><br></pre></td></tr></table></figure>


<h2 id="2、wazuh-server配置"><a href="#2、wazuh-server配置" class="headerlink" title="2、wazuh server配置"></a>2、wazuh server配置</h2><p>1）将以下规则添加到Wazuh服务器上的 /var/ossec/etc/rules/local_rules.xml 文件中：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">group</span> <span class="attr">name</span>=<span class="string">"ossec,"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">rule</span> <span class="attr">id</span>=<span class="string">"100050"</span> <span class="attr">level</span>=<span class="string">"0"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">if_sid</span>&gt;</span>530<span class="tag">&lt;/<span class="name">if_sid</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">match</span>&gt;</span>^ossec: output: 'process list'<span class="tag">&lt;/<span class="name">match</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>List of running processes.<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">group</span>&gt;</span>process_monitor,<span class="tag">&lt;/<span class="name">group</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">rule</span> <span class="attr">id</span>=<span class="string">"100051"</span> <span class="attr">level</span>=<span class="string">"7"</span> <span class="attr">ignore</span>=<span class="string">"900"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">if_sid</span>&gt;</span>100050<span class="tag">&lt;/<span class="name">if_sid</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">match</span>&gt;</span>nc -l<span class="tag">&lt;/<span class="name">match</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>netcat listening for incoming connections.<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">group</span>&gt;</span>process_monitor,<span class="tag">&lt;/<span class="name">group</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">group</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>这个配置片段定义了一个监控逻辑，专门用于在系统进程列表中检测监听模式的 netcat(<code>nc -l</code>)，一旦发现就产生高优先级告警。规则 100050 负责捕获进程列表数据，规则 100051 负责在其中搜索特定的威胁指标 (<code>nc -l</code>)。</p>
<p>2）重新启动Wazuh管理器以使配置生效：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl restart wazuh-manager</span><br></pre></td></tr></table></figure>

<h1 id="三、模拟攻击"><a href="#三、模拟攻击" class="headerlink" title="三、模拟攻击"></a>三、模拟攻击</h1><p>在被监控的Kali主机（192.168.0.65）端点上，运行<code>nc -l 8000</code> 30秒。</p>
<p>netcat​（网络工具中的“瑞士军刀”）的命令，它的核心作用是：​在你的计算机上启动一个临时的 TCP 服务端，监听端口 8000，等待其他计算机连接并与之通信。</p>
<p>监听模式的 netcat常被用作后门、端口监听器或进行未经授权的文件传输，是攻击者建立持久访问或进行横向移动的常见工具。</p>
<h1 id="四、效果验证"><a href="#四、效果验证" class="headerlink" title="四、效果验证"></a>四、效果验证</h1><p>我们可以在Wazuh威胁狩猎模块仪表板中可看到检测到kali主机上有netcat 进行正在监听的告警并可视化展示出来。<br><img src="http://image2.ishareread.com/images/2025/20251015/2-%E9%9D%9E%E6%B3%95%E5%8F%AF%E7%96%91%E8%BF%9B%E7%A8%8B%E6%A3%80%E6%B5%8B%E5%91%8A%E8%AD%A6.png" alt="非法可疑进程检测告警"></p>
<p>我们点开告警详情可以看到日志中显示通过<code>ps -e -o pid,uname,command</code>，检测到有<code>nc -l 8000</code>的非法进程在运行，进行了<code>netcat listening for incoming connections.</code>告警输出。<br><img src="http://image2.ishareread.com/images/2025/20251015/3-%E9%9D%9E%E6%B3%95%E5%8F%AF%E7%96%91%E8%BF%9B%E7%A8%8B%E6%A3%80%E6%B5%8B%E5%91%8A%E8%AD%A6%E8%AF%A6%E6%83%85.png" alt="非法可疑进程检测告警详情"></p>
<p>至此，我们通过一个完整的POC实例验证了wuzuh对非法可疑进程的检测，能够有效发现潜在的威胁。</p>
<hr>
<p>作者博客：<a href="http://xiejava.ishareread.com/">http://xiejava.ishareread.com/</a></p>
<center> 

<br>

<p><img src="http://image2.ishareread.com/images/fullbug%E5%BE%AE%E4%BF%A1%E5%85%AC%E4%BC%97%E5%8F%B7.jpg" alt="“fullbug”微信公众号" title="“fullbug”微信公众号"> </p>
<p>关注：微信公众号,一起学习成长！</center></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://xiejava.ishareread.com/posts/b9af79aa/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="XieJava">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://img9.doubanio.com/icon/ul70489051-4.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="XieJava's blog">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/posts/b9af79aa/" itemprop="url">开源安全管理平台wazuh-与网络入侵检测系统集成增强威胁检测能力</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2025-10-12T16:19:42+08:00">
                2025-10-12
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">更新于&#58;</span>
              
              <time title="更新于" itemprop="dateModified" datetime="2025-12-17T19:21:52+08:00">
                2025-12-17
              </time>
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index">
                    <span itemprop="name">技术</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%8A%80%E6%9C%AF/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/" itemprop="url" rel="index">
                    <span itemprop="name">网络安全</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/posts/b9af79aa/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/posts/b9af79aa/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/posts/b9af79aa/" class="leancloud_visitors" data-flag-title="开源安全管理平台wazuh-与网络入侵检测系统集成增强威胁检测能力">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  1.1k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  4
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Wazuh是一个功能强大的开源安全平台，它集成了安全信息与事件管理（SIEM）和扩展检测与响应（XDR）的能力，旨在为本地、虚拟化、容器化及云环境中的工作负载提供统一的威胁预防、检测和响应解决方案。</p>
<p>Wazuh可以与基于网络的入侵检测系统（NIDS）集成，通过监控和分析网络流量来增强威胁检测。Suricata 是一个开源的高性能网络安全监控工具，由开放信息安全基金会（OISF）开发维护。它被广泛用于实时网络流量分析、威胁检测和防护。Suricata 是现代网络安全架构中的重要组件，特别适合需要高性能实时流量分析的场景，是构建深度防御体系的关键工具。</p>
<p>本文通过POC展示如何将Suricata与Wazuh集成，并模拟对目标主机进行端口扫描，通过Suricata监控和分析网络流量进行威胁检测与Wazuh集成后在Wazuh的威胁狩猎中及时预警威胁攻击行为。</p>
<h1 id="一、环境准备"><a href="#一、环境准备" class="headerlink" title="一、环境准备"></a>一、环境准备</h1><p>POC环境拓扑如下图所示：<br><img src="http://image2.ishareread.com/images/2025/20251012/1-POC%E6%8B%93%E6%89%91%E5%9B%BE.png" alt="POC环境拓扑图"></p>
<table>
<thead>
<tr>
<th>主机</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>安全管理平台wazuh-server<br>(192.168.0.40)</td>
<td>All in one安装wazuh，监控wazuh-agent、suricata上报的告警信息进行威胁检测</td>
</tr>
<tr>
<td>ubuntu应用服务器<br>（192.168.0.30）</td>
<td>ubuntu应用服务器安装wazuh-agent并与Suricata集成 ,模拟被攻击的服务器</td>
</tr>
<tr>
<td>Kali Linux模拟攻击机器<br>（192.168.0.65）</td>
<td>Kali linux ,模拟攻击机器，模拟发起恶意端口扫描攻击</td>
</tr>
</tbody></table>
<h1 id="二、安装Suricata"><a href="#二、安装Suricata" class="headerlink" title="二、安装Suricata"></a>二、安装Suricata</h1><h2 id="1、安装Suricata"><a href="#1、安装Suricata" class="headerlink" title="1、安装Suricata"></a>1、安装Suricata</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo add-apt-repository ppa:oisf/suricata-stable</span><br><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install suricata -y</span><br></pre></td></tr></table></figure>

<h2 id="2、下载Suricata的扩展检测规则集"><a href="#2、下载Suricata的扩展检测规则集" class="headerlink" title="2、下载Suricata的扩展检测规则集"></a>2、下载Suricata的扩展检测规则集</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /tmp/ &amp;&amp; curl -LO https://rules.emergingthreats.net/open/suricata-6.0.8/emerging.rules.tar.gz</span><br><span class="line">sudo tar -xvzf emerging.rules.tar.gz &amp;&amp; sudo mkdir /etc/suricata/rules &amp;&amp; sudo mv rules/*.rules /etc/suricata/rules/</span><br><span class="line">sudo chmod 777 /etc/suricata/rules/*.rules</span><br></pre></td></tr></table></figure>

<h2 id="3、配置Surcata"><a href="#3、配置Surcata" class="headerlink" title="3、配置Surcata"></a>3、配置Surcata</h2><p>在 <code>/etc/suricata/suricata.yaml</code> 文件中修改 Suricata 设置并设置以下变量</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">HOME_NET: <span class="string">"&lt;UBUNTU_IP&gt;"</span></span><br><span class="line">EXTERNAL_NET: <span class="string">"any"</span></span><br><span class="line"></span><br><span class="line">default-rule-path: /etc/suricata/rules</span><br><span class="line">rule-files:</span><br><span class="line">- <span class="string">"*.rules"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Global stats configuration</span></span><br><span class="line">stats:</span><br><span class="line">enabled: yes</span><br><span class="line"></span><br><span class="line"><span class="comment"># Linux high speed capture support</span></span><br><span class="line">af-packet:</span><br><span class="line">  - interface: ens2</span><br></pre></td></tr></table></figure>

<p>接口表示您想要监控的网络接口。将值替换为 Ubuntu 端点的接口名称。</p>
<p><img src="http://image2.ishareread.com/images/2025/20251012/2-%E8%AE%BE%E7%BD%AE%E4%B8%BA%E6%B5%81%E9%87%8F%E6%A3%80%E6%B5%8B%E7%9A%84%E7%BD%91%E5%8D%A1.png" alt="设置为流量检测的网卡"></p>
<p>可以通过ifconfig查看Ubuntu的网络接口，例如，我这里是ens2。<br><img src="http://image2.ishareread.com/images/2025/20251012/3-ifconfig%E6%9F%A5%E7%9C%8B%E7%BD%91%E5%8D%A1.png" alt="查看网络接口"></p>
<h2 id="4、重启Suricata服务"><a href="#4、重启Suricata服务" class="headerlink" title="4、重启Suricata服务"></a>4、重启Suricata服务</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl restart suricata</span><br></pre></td></tr></table></figure>

<h1 id="三、wazuh与Suricata集成"><a href="#三、wazuh与Suricata集成" class="headerlink" title="三、wazuh与Suricata集成"></a>三、wazuh与Suricata集成</h1><p>将以下配置添加到Wazuh代理的<code>/var/ossec/etc/ossec.conf</code>文件中。这允许Wazuh代理读取Suricata日志文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;ossec_config&gt;</span><br><span class="line">  &lt;localfile&gt;</span><br><span class="line">    &lt;log_format&gt;json&lt;/log_format&gt;</span><br><span class="line">    &lt;location&gt;/var/<span class="built_in">log</span>/suricata/eve.json&lt;/location&gt;</span><br><span class="line">  &lt;/localfile&gt;</span><br><span class="line">&lt;/ossec_config&gt;</span><br></pre></td></tr></table></figure>

<p><img src="http://image2.ishareread.com/images/2025/20251012/4-%E9%85%8D%E7%BD%AEwazuh%E6%8E%A5%E6%94%B6suricata%E6%95%B0%E6%8D%AE.png" alt="配置wazuh接受suricata数据"></p>
<p>重新启动Wazuh代理以使配置生效</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl restart wazuh-agent</span><br></pre></td></tr></table></figure>

<h1 id="四、模拟攻击"><a href="#四、模拟攻击" class="headerlink" title="四、模拟攻击"></a>四、模拟攻击</h1><blockquote>
<p>请注意：本文介绍的模拟攻击仅限于自己搭建测试环境进行POC验证。请不要使用这些工具和方法对其它目标主机进行测试，使用这些工具前，务必获得目标系统的明确书面授权，未经授权的测试属违法行为。</p>
</blockquote>
<p>端口扫描是渗透测试的第一步，通过端口扫描可以快速发现目标主机的攻击面。使用 nmap进行端口扫描是网络安全中最基础且关键的操作之一。我们在Kali Linux主机上通过nmap对目标靶机192.168.0.30进行端口扫描看开放有哪些端口。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap -p- -sV -O -A -T4 -Pn -oX full_scan.xml 192.168.0.30</span><br></pre></td></tr></table></figure>

<h1 id="五、效果验证"><a href="#五、效果验证" class="headerlink" title="五、效果验证"></a>五、效果验证</h1><p>在Kali Linux主机上通过nmap对目标靶机192.168.0.30进行端口扫描的过程中，我们在192.168.0.40的wazuh server的威胁狩猎界面可以看到suricata通过流量检测识别到端口扫描的攻击行为，并通过wazuh的可视化界面进行告警的展示。</p>
<p><img src="http://image2.ishareread.com/images/2025/20251012/5-suricata%E5%91%8A%E8%AD%A6.png" alt="surcata告警"></p>
<p>点击可以查看告警的详情，可以看到是通过suricata发现的来自源IP192.168.0.65的nmap扫描行为。</p>
<p><img src="http://image2.ishareread.com/images/2025/20251012/6-suricata%E5%91%8A%E8%AD%A6%E8%AF%A6%E6%83%85.png" alt="suricata告警详情"></p>
<p>至此，我们通过wasuh与网络入侵检测系统（suricata）进行集成，并模拟对目标主机进行端口扫描，验证了通过Suricata监控和分析网络流量进行威胁检测与Wazuh集成后在Wazuh的威胁狩猎中及时预警威胁攻击行为。</p>
<hr>
<p>作者博客：<a href="http://xiejava.ishareread.com/">http://xiejava.ishareread.com/</a></p>
<center> 

<br>

<p><img src="http://image2.ishareread.com/images/fullbug%E5%BE%AE%E4%BF%A1%E5%85%AC%E4%BC%97%E5%8F%B7.jpg" alt="“fullbug”微信公众号" title="“fullbug”微信公众号"> </p>
<p>关注：微信公众号,一起学习成长！</center></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://xiejava.ishareread.com/posts/c76cd9e6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="XieJava">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://img9.doubanio.com/icon/ul70489051-4.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="XieJava's blog">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/posts/c76cd9e6/" itemprop="url">开源安全管理平台wazuh-暴力破解检测与响应</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2025-10-11T14:25:00+08:00">
                2025-10-11
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">更新于&#58;</span>
              
              <time title="更新于" itemprop="dateModified" datetime="2025-12-17T19:21:52+08:00">
                2025-12-17
              </time>
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index">
                    <span itemprop="name">技术</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%8A%80%E6%9C%AF/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/" itemprop="url" rel="index">
                    <span itemprop="name">网络安全</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/posts/c76cd9e6/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/posts/c76cd9e6/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/posts/c76cd9e6/" class="leancloud_visitors" data-flag-title="开源安全管理平台wazuh-暴力破解检测与响应">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  1.5k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  5
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Wazuh是一个功能强大的开源安全平台，它集成了安全信息与事件管理（SIEM）和扩展检测与响应（XDR）的能力，旨在为本地、虚拟化、容器化及云环境中的工作负载提供统一的威胁预防、检测和响应解决方案。</p>
<p>暴力破解是网络安全领域一种常见且顽固的威胁，像Linux端点的SSH这样的服务通常容易受到暴力破解攻击，攻击者利用它来非法访问端点和服务。有效应对暴力破解需要“侦测”和“防护”双管齐下。Wazuh通过关联多个认证失败事件来识别暴力破解攻击并可以配置主动响应以阻止攻击者的IP地址。</p>
<p>本文通过POC来验证wazuh对暴力破解检测与响应能力</p>
<h1 id="一、环境准备"><a href="#一、环境准备" class="headerlink" title="一、环境准备"></a>一、环境准备</h1><p>POC环境如下图所示：</p>
<p><img src="http://image2.ishareread.com/images/2025/20251011/1-POC%E6%8B%93%E6%89%91%E5%9B%BE.png" alt="POC拓扑图"></p>
<table>
<thead>
<tr>
<th>主机</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>安全管理平台wazuh-server<br>(192.168.0.40)</td>
<td>All in one安装wazuh，监控wazuh-agent上报的告警信息进行暴力破解检测并联动wazuh-agent进行封堵响应</td>
</tr>
<tr>
<td>ubuntu应用服务器<br>（192.168.0.30）</td>
<td>ubuntu应用服务器ssh服务，安装wazuh-agent ,模拟被攻击的服务器</td>
</tr>
<tr>
<td>Kali Linux模拟攻击机器<br>（192.168.0.65）</td>
<td>Kali linux ,模拟攻击机器</td>
</tr>
</tbody></table>
<h1 id="二、wazuh-配置"><a href="#二、wazuh-配置" class="headerlink" title="二、wazuh 配置"></a>二、wazuh 配置</h1><p>Wazuh使用主动响应模块在受监控端点上运行脚本或可执行文件，对某些触发器采取行动。在本用例中，我们模拟对ubuntu应用服务器端点的SSH暴力破解攻击，并配置主动响应模块以阻止攻击端点的IP地址。目标是防止SSH暴力破解攻击。</p>
<p>Wazuh附带一套用于主动响应的默认脚本。这些脚本位于Linux/Unix端点的<code>/var/ossec/active-response/bin/</code>目录中。firewall-drop主动响应脚本与Linux/Unix操作系统兼容。它使用iptables来阻止恶意IP地址。</p>
<h2 id="Wazuh-server配置"><a href="#Wazuh-server配置" class="headerlink" title="Wazuh server配置"></a>Wazuh server配置</h2><p>1、打开Wazuh服务器<code>/var/ossec/etc/ossec.conf</code>文件，并验证在<code>&lt;ossec_config&gt;</code>块中存在名为firewall-drop的<code>&lt;command&gt;</code>块，其配置如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">command</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>firewall-drop<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">executable</span>&gt;</span>firewall-drop<span class="tag">&lt;/<span class="name">executable</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">timeout_allowed</span>&gt;</span>yes<span class="tag">&lt;/<span class="name">timeout_allowed</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">command</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>&lt;command&gt;</code>块包含有关在Wazuh代理上执行的操作的信息：</p>
<ul>
<li><code>&lt;name&gt;</code>：为命令设置名称。在本例中，为firewall-drop。</li>
<li><code>&lt;executable&gt;</code>：指定在触发时必须运行的响应脚本或可执行文件。在本例中，是firewall-drop可执行文件。</li>
<li><code>&lt;timeout_allowed&gt;</code>：允许在一段时间后超时。在此处，此标签设置为yes，表示状态性主动响应。</li>
</ul>
<p>2、将以下 <code>&lt;active-response&gt;</code> 块添加到 Wazuh 服务器 <code>/var/ossec/etc/ossec.conf</code> 配置文件中：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">ossec_config</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">active-response</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">disabled</span>&gt;</span>no<span class="tag">&lt;/<span class="name">disabled</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">command</span>&gt;</span>firewall-drop<span class="tag">&lt;/<span class="name">command</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">location</span>&gt;</span>local<span class="tag">&lt;/<span class="name">location</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rules_id</span>&gt;</span>5763<span class="tag">&lt;/<span class="name">rules_id</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">timeout</span>&gt;</span>180<span class="tag">&lt;/<span class="name">timeout</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">active-response</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ossec_config</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>&lt;comand&gt;</code>：指定要配置的命令。这是在上一步骤中定义的防火墙丢弃命令 firewall-drop。</li>
<li><code>&lt;location&gt;</code>：指定命令执行的位置。使用本地值表示命令在触发事件发生的监控端点处执行。</li>
<li><code>&lt;rules_id&gt;</code>：如果规则ID 5763 - SSHD暴力破解尝试访问系统触发，则活动响应模块将执行该命令。</li>
<li><code>&lt;timeout&gt;</code>：指定活动响应操作必须持续的时间。在本用例中，模块将阻止执行暴力破解攻击的端点IP地址180秒。</li>
</ul>
<p>3、重新启动Wazuh管理器服务以应用更改：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl restart wazuh-manager</span><br></pre></td></tr></table></figure>

<h1 id="三、模拟攻击"><a href="#三、模拟攻击" class="headerlink" title="三、模拟攻击"></a>三、模拟攻击</h1><p>我们通过Kali Linux自带的Hydra进行模拟攻击。</p>
<blockquote>
<p>请注意：本文介绍的模拟攻击仅限于自己搭建测试环境进行POC验证。请不要使用这些工具和方法对其它目标主机进行测试，使用这些工具前，务必获得目标系统的明确书面授权，未经授权的测试属违法行为。</p>
</blockquote>
<p>Hydra 配合 SecLists 工具包，可以显著提升密码破解测试的效率和成功率。<br>SecLists 是一款在安全测试中非常受欢迎的开源集合项目，提供了各种类型的字典列表，包括但不限于用户名、密码、目录路径、子域名等。Hydra 则是一款强大的网络登录破解工具，支持多种协议。将两者结合，可以针对各种网络服务进行高效的密码暴力破解测试。<br>在 Kali Linux 中，SecLists 通常位于 <code>/usr/share/seclists</code>目录。如果系统未安装，可以使用以下命令安装：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt update &amp;&amp; sudo apt install seclists</span><br></pre></td></tr></table></figure>

<p>在Kali Linux（192.168.0.65）上执行hydra 对 192.168.0.30 进行模拟攻击</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hydra -L /usr/share/seclists/Usernames/top-usernames-shortlist.txt -P /usr/share/seclists/Passwords/Common-Credentials/top-20-common-SSH-passwords.txt 192.168.0.30 ssh -t 4 -vV</span><br></pre></td></tr></table></figure>

<h1 id="四、效果验证"><a href="#四、效果验证" class="headerlink" title="四、效果验证"></a>四、效果验证</h1><p>可以看到触发了wazuh的告警规则，在Wazuh仪表板中看到多次的登录失败的告警数据，并生成了试图暴力破解的攻击告警。<br><img src="http://image2.ishareread.com/images/2025/20251011/2-%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3%E6%A3%80%E6%B5%8B%E4%B8%8E%E5%93%8D%E5%BA%94%E5%91%8A%E8%AD%A6.png" alt="告警"></p>
<p>在详情中可以清楚的看到多次尝试暴力破解ssh登录<br><img src="http://image2.ishareread.com/images/2025/20251011/3-%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3%E5%91%8A%E8%AD%A6%E8%AF%A6%E6%83%85.png" alt="告警详情"></p>
<p>可以看到wazuh检测到有ssh暴力破解的行为并自动调用防火墙对攻击IP进行封堵，封堵180秒。<br><img src="http://image2.ishareread.com/images/2025/20251011/4-%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3%E5%91%8A%E8%AD%A6%E5%B0%81%E5%A0%B5.png" alt="封堵"></p>
<p>在Hydra的攻击日志可以看到，被wazuh进行响应封堵后ssh超时报错，说明已经成功阻断阻止了攻击行为。<br><img src="http://image2.ishareread.com/images/2025/20251011/5-%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3%E5%B0%81%E5%A0%B5%E6%95%88%E6%9E%9C.png" alt="阻止效果"></p>
<p>至此，我们通过一个实际的POC实例验证了wazuh对ssh暴力破解攻击行为的检测和响应，通过“侦测”和“防护”双管齐下能有效减轻ssh暴力破解威胁攻击风险。</p>
<hr>
<p>作者博客：<a href="http://xiejava.ishareread.com/">http://xiejava.ishareread.com/</a></p>
<center> 

<br>

<p><img src="http://image2.ishareread.com/images/fullbug%E5%BE%AE%E4%BF%A1%E5%85%AC%E4%BC%97%E5%8F%B7.jpg" alt="“fullbug”微信公众号" title="“fullbug”微信公众号"> </p>
<p>关注：微信公众号,一起学习成长！</center></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/23/">23</a><a class="extend next" rel="next" href="/page/2/">&gt;</a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
      <div id="sidebar-dimmer"></div>
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="https://img9.doubanio.com/icon/ul70489051-4.jpg"
                alt="XieJava" />
            
              <p class="site-author-name" itemprop="name">XieJava</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives">
              
                  <span class="site-state-item-count">222</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">14</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">28</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          <div class="links-of-author motion-element">
            
              
                <span class="links-of-author-item">
                  <a href="https://github.com/xiejava1018" target="_blank" title="GitHub">
                    
                      <i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
            
          </div>

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-inline">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                友情链接
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.ishareread.com/" title="爱分享读书" target="_blank">爱分享读书</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://blog.csdn.net/fullbug" title="CSDN" target="_blank">CSDN</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.douban.com/people/xiejava/" title="豆瓣" target="_blank">豆瓣</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2026</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">XieJava</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">Site words total count&#58;</span>
    
    <span title="Site words total count">451.8k</span>
  
  
<!--51la网站应用监控-->
<script src="https://sdk.51.la/perf/js-sdk-perf.min.js" crossorigin="anonymous"></script>
<script>
  new LingQue.Monitor().init({id:"JdyGwOQm8BurILgP"});
</script>
<!--51la网站访问统计-->
<script charset="UTF-8" id="LA_COLLECT" src="//sdk.51.la/js-sdk-pro.min.js"></script>
<script>LA.init({id: "JdyBT51UUKIm9A1e",ck: "JdyBT51UUKIm9A1e"})</script>
<br>
<script id="LA-DATA-WIDGET" crossorigin="anonymous" src="https://v6-widget.51.la/v6/JdyBT51UUKIm9A1e/quote.js?theme=0&f=12"></script>
<br>
<a target="_blank" title="51la网站统计" href="https://v6.51.la/land/JdyBT51UUKIm9A1e"><img src="https://sdk.51.la/icon/2-4.png"></a>
</div>






  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a></div>




        







  <div >
    <!-- 友盟代码 -->
    <script type="text/javascript">document.write(unescape("%3Cspan id='cnzz_stat_icon_1278575888'%3E%3C/span%3E%3Cscript src='https://v1.cnzz.com/z_stat.php%3Fid%3D1278575888%26online%3D1%26show%3Dline' type='text/javascript'%3E%3C/script%3E"));</script>
	<!-- 友盟代码 end -->
  </div>



        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.3.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.3.0"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.3.0"></script>




  


  




	





  





  










  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="//unpkg.com/valine/dist/Valine.min.js"></script>
  
  <script type="text/javascript">
    var GUEST = ['nick','mail','link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item=>{
      return GUEST.indexOf(item)>-1;
    });
    new Valine({
        el: '#comments' ,
        verify: true,
        notify: true,
        appId: 'LfKg3xroRwHlese1o0oSY2zx-gzGzoHsz',
        appKey: 'NXbIDcd2qs0UWvoi0MXdwbmW',
        placeholder: 'Just go go',
        avatar:'mm',
        guest_info:guest,
        pageSize:'10' || 10,
    });
  </script>



  





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("LfKg3xroRwHlese1o0oSY2zx-gzGzoHsz", "NXbIDcd2qs0UWvoi0MXdwbmW");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  
  

  

  
  <script type="text/javascript" src="/js/src/js.cookie.js?v=6.3.0"></script>
  <script type="text/javascript" src="/js/src/scroll-cookie.js?v=6.3.0"></script>


  


</body>
</html>
